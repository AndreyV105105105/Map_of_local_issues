{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ issue.title }} - {% trans "Детали проблемы" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/issue_detail.css' %}">
    <link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <div class="issue-detail-container">
        <div class="issue-header">
            <h1 class="issue-title">{{ issue.title }}</h1>
            <div class="issue-meta">
                <span class="meta-date">{{ issue.created_at|date:"d.m.Y H:i" }}</span>
                <span class="meta-separator">·</span>
                <span class="meta-category">{{ issue.get_category_display }}</span>
                <span class="meta-separator">·</span>
                <span class="issue-status-badge status-{{ issue.status }}">{{ issue.get_status_display }}</span>
            </div>
        </div>

        <div class="issue-content-grid">
            <main class="issue-main-content">
                <section class="issue-description">
                    <h3>{% trans "Описание проблемы" %}</h3>
                    <div class="description-content">
                        <p>{{ issue.description|default:"—" }}</p>
                    </div>
                </section>

                {% if issue.photos.all %}
                <section class="issue-photos">
                    <h3>{% trans "Фотографии проблемы" %}</h3>
                    <div class="photos-grid">
                        {% for photo in issue.photos.all %}
                        <div class="photo-item">
                            <a href="{{ photo.image.url }}" target="_blank">
                                <img src="{{ photo.image.url }}" alt="Фото проблемы {{ forloop.counter }}">
                            </a>
                            <div class="photo-caption">
                                <span>{{ forloop.counter }}/{{ issue.photos.count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <section class="issue-voting">
                    <div class="voting-header">
                        <span class="rating-value" data-issue-id="{{ issue.id }}">{{ issue.vote_rating }}</span>
                        <span class="rating-label">{% trans "рейтинг" %}</span>
                    </div>

                    {% if user.is_authenticated and user.role == 'citizen' %}
                        <div class="vote-buttons">
                            <button type="button" 
                                    class="vote-btn upvote-btn {% if issue.user_has_upvoted %}active{% endif %}"
                                    data-issue-id="{{ issue.id }}"
                                    data-direction="1">
                                <img src="{% static 'icons/upvote.svg' %}" alt="Нравится">
                            </button>
                            <button type="button" 
                                    class="vote-btn downvote-btn {% if issue.user_has_downvoted %}active{% endif %}"
                                    data-issue-id="{{ issue.id }}"
                                    data-direction="-1">
                                <img src="{% static 'icons/downvote.svg' %}" alt="Не нравится">
                            </button>
                        </div>
                    {% endif %}
                </section>

                <section class="issue-details">
                    <h3>{% trans "Детали проблемы" %}</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Автор" %}</span>
                            <span class="detail-value">
                                {% if user.is_authenticated and user.role == 'official' %}
                                    {{ issue.reporter.get_full_name }} 
                                    {% if issue.reporter.email %}({{ issue.reporter.email }}){% endif %}
                                {% else %}
                                    {{ issue.reporter.get_full_name }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Статус" %}</span>
                            <span class="detail-value">{{ issue.get_status_display }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Категория" %}</span>
                            <span class="detail-value">{{ issue.get_category_display }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Координаты" %}</span>
                            <span class="detail-value coordinates">
                                {{ issue.location.x|floatformat:6 }}, {{ issue.location.y|floatformat:6 }}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Рейтинг" %}</span>
                            <span class="detail-value">
                                <span class="rating-badge">{{ issue.vote_rating }}</span>
                                {% if user.is_authenticated and user.role == 'citizen' %}
                                    <small class="user-vote-status">
                                        {% if issue.user_has_upvoted %}
                                            ({% trans "Вы проголосовали за" %})
                                        {% elif issue.user_has_downvoted %}
                                            ({% trans "Вы проголосовали против" %})
                                        {% else %}
                                            ({% trans "Вы не голосовали" %})
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Фотографии" %}</span>
                            <span class="detail-value">{{ issue.photos.count }}</span>
                        </div>
                    </div>
                </section>

                <div class="issue-actions">
                    <a href="{% url 'issues:map' %}" class="btn btn-secondary">
                        ← {% trans "Вернуться к карте" %}
                    </a>

                    {% if user.is_authenticated and user.role == 'official' %}
                        <form method="post" action="{% url 'issues:delete_issue' issue.id %}"
                              onsubmit="return confirm('{% trans "Удалить обращение? Действие нельзя отменить." %}');"
                              class="delete-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                {% trans "Удалить проблему" %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </main>

            <aside class="issue-sidebar">
                <div class="location-card">
                    <h4>{% trans "Местоположение" %}</h4>
                    <div id="mini-map" class="map-container"></div>
                </div>

                {% if issue.photos.all %}
                <div class="main-photo-card">
                    <h4>{% trans "Основное фото" %}</h4>
                    <div class="main-photo-container">
                        <a href="{{ issue.photos.first.image.url }}" target="_blank">
                            <img src="{{ issue.photos.first.image.url }}" alt="Основное фото проблемы">
                        </a>
                    </div>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>

    {% csrf_token %}
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
    <script src="{% static 'issue_detail.js' %}"></script>
{% endblock %}