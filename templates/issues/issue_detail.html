{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ issue.title }} - {% trans "–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/issue_detail.css' %}">
    <link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <div class="issue-detail-container">
        <div class="issue-header">
            <h1 class="issue-title">{{ issue.title }}</h1>
            <div class="issue-meta">
                <span class="meta-date">{{ issue.created_at|date:"d.m.Y H:i" }}</span>
                <span class="meta-separator">¬∑</span>
                <span class="meta-category">{{ issue.get_category_display }}</span>
                <span class="meta-separator">¬∑</span>
                <span class="issue-status-badge status-{{ issue.status }}">{{ issue.get_status_display }}</span>
            </div>
        </div>

        <div class="issue-content-grid">
            <main class="issue-main-content">
                <section class="issue-description">
                    <h3>{% trans "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã" %}</h3>
                    <div class="description-content">
                        <p>{{ issue.description|default:"‚Äî" }}</p>
                    </div>
                </section>

                {% if issue.photos.all %}
                <section class="issue-photos">
                    <h3>{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã" %}</h3>
                    <div class="photos-grid">
                        {% for photo in issue.photos.all %}
                        <div class="photo-item">
                            <a href="{{ photo.image.url }}" target="_blank">
                                <img src="{{ photo.image.url }}" alt="–§–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã {{ forloop.counter }}">
                            </a>
                            <div class="photo-caption">
                                <span>{{ forloop.counter }}/{{ issue.photos.count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <section class="issue-voting">
                    <div class="voting-header">
                        <span class="rating-value" data-issue-id="{{ issue.id }}">{{ issue.vote_rating }}</span>
                        <span class="rating-label">{% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}</span>
                    </div>

                    {% if user.is_authenticated and user.role == 'citizen' %}
                        <div class="vote-buttons">
                            <button type="button" 
                                    class="vote-btn upvote-btn {% if issue.user_has_upvoted %}active{% endif %}"
                                    data-issue-id="{{ issue.id }}"
                                    data-direction="1"
                                    onclick="toggleVote({{ issue.id }}, 1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                                <img src="{% static 'icons/like.svg' %}" alt="–ù—Ä–∞–≤–∏—Ç—Å—è">
                            </button>
                            <button type="button" 
                                    class="vote-btn downvote-btn {% if issue.user_has_downvoted %}active{% endif %}"
                                    data-issue-id="{{ issue.id }}"
                                    data-direction="-1"
                                    onclick="toggleVote({{ issue.id }}, -1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                                <img src="{% static 'icons/dislike.svg' %}" alt="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
                            </button>
                        </div>
                    {% endif %}
                </section>

                <section class="issue-details">
                    <h3>{% trans "–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã" %}</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–ê–≤—Ç–æ—Ä" %}</span>
                            <span class="detail-value">
                                {% if user.is_authenticated and user.role == 'official' %}
                                    {{ issue.reporter.get_full_name }} 
                                    {% if issue.reporter.email %}({{ issue.reporter.email }}){% endif %}
                                {% else %}
                                    {{ issue.reporter.get_full_name }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–°—Ç–∞—Ç—É—Å" %}</span>
                            <span class="detail-value">{{ issue.get_status_display }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</span>
                            <span class="detail-value">{{ issue.get_category_display }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–ê–¥—Ä–µ—Å" %}</span>
                            <span class="detail-value">{{ issue.address|default:"‚Äî" }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" %}</span>
                            <span class="detail-value coordinates">
                                {{ issue.location.x|floatformat:6 }}, {{ issue.location.y|floatformat:6 }}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–†–µ–π—Ç–∏–Ω–≥" %}</span>
                            <span class="detail-value">
                                <span class="rating-badge">{{ issue.vote_rating }}</span>
                                {% if user.is_authenticated and user.role == 'citizen' %}
                                    <small class="user-vote-status">
                                        {% if issue.user_has_upvoted %}
                                            ({% trans "–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞" %})
                                        {% elif issue.user_has_downvoted %}
                                            ({% trans "–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ø—Ä–æ—Ç–∏–≤" %})
                                        {% else %}
                                            ({% trans "–í—ã –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏" %})
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %}</span>
                            <span class="detail-value">{{ issue.photos.count }}</span>
                        </div>
                    </div>
                </section>

                <!-- Comment Section -->
                <section class="issue-comments">
                    <h3>{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" %} ({{ issue.comments.count }})</h3>
                    
                    <div class="comments-list">
                        {% if issue.comments.exists %}
                            {% for comment in issue.comments.all %}
                                <div class="comment-item">
                                    <div class="comment-avatar">
                                        {% if comment.author.profile_picture %}
                                            <img src="{{ comment.author.profile_picture.url }}" alt="Avatar" width="40" height="40">
                                        {% else %}
                                            <div class="avatar-placeholder">
                                                {{ comment.author.first_name.0|default:"A" }}{{ comment.author.last_name.0|default:"U" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="comment-content">
                                        <div class="comment-header">
                                            <div class="comment-author-info">
                                                <strong>{{ comment.author.get_full_name }}</strong>
                                                <span class="comment-role {% if comment.author.role == 'official' %}role-official{% endif %}">
                                                    {{ comment.author.get_role_display }}
                                                </span>
                                            </div>
                                            <small class="comment-time">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                        </div>
                                        <p class="comment-text">{{ comment.text }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-comments">{% trans "–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!" %}</p>
                        {% endif %}
                    </div>

                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'issues:issue_detail' issue.pk %}" class="comment-form">
                            {% csrf_token %}
                            <div class="form-group">
                                {{ comment_form.text }}
                            </div>
                            <button type="submit" class="btn btn-primary">
                                {% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" %}
                            </button>
                            <small class="form-text">
                                {% if user.role == 'citizen' %}
                                    {% trans "–í—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ –∫–∞–∫ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω" %}
                                {% else %}
                                    {% trans "–í—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ª–∏—Ü–æ" %}
                                {% endif %}
                            </small>
                        </form>
                    {% else %}
                        <div class="alert alert-info">
                            {% trans "–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" %}
                        </div>
                    {% endif %}
                </section>

                <div class="issue-actions">
                    <a href="{% url 'issues:map' %}" class="btn btn-secondary">
                        ‚Üê {% trans "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ä—Ç–µ" %}
                    </a>

                    {% if user.is_authenticated and user.role == 'official' %}
                        <form method="post" action="{% url 'issues:delete_issue' issue.id %}"
                              onsubmit="return confirm('{% trans "–£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." %}');"
                              class="delete-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                {% trans "–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É" %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </main>

            <aside class="issue-sidebar">
                <div class="location-card">
                    <h4>{% trans "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" %}</h4>
                    <div id="mini-map" class="map-container"></div>
                </div>

                {% if issue.photos.all %}
                <div class="main-photo-card">
                    <h4>{% trans "–û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ" %}</h4>
                    <div class="main-photo-container">
                        <a href="{{ issue.photos.first.image.url }}" target="_blank">
                            <img src="{{ issue.photos.first.image.url }}" alt="–û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã">
                        </a>
                    </div>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>

    {% csrf_token %}
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
    <script>
        // –ö–∞—Ä—Ç–∞
        document.addEventListener('DOMContentLoaded', () => {
            const mapDiv = document.getElementById('mini-map');
            if (!mapDiv) return;

            const lng = {{ issue.location.x|floatformat:6 }};
            const lat = {{ issue.location.y|floatformat:6 }};

            try {
                const miniMap = new maplibregl.Map({
                    container: 'mini-map',
                    style: {
                        version: 8,
                        sources: {
                            'osm-de': {
                                type: 'raster',
                                tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
                                tileSize: 256,
                                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }
                        },
                        layers: [{
                            id: 'osm-de-tiles',
                            type: 'raster',
                            source: 'osm-de',
                            minzoom: 0,
                            maxzoom: 19
                        }]
                    },
                    center: [lng, lat],
                    zoom: 14,
                    interactive: false,
                    attributionControl: true
                });

                // –ú–∞—Ä–∫–µ—Ä
                new maplibregl.Marker({ color: '#e74c3c' })
                    .setLngLat([lng, lat])
                    .addTo(miniMap);

                // –£–±–∏—Ä–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø MapLibre
                miniMap.on('load', () => {
                    const logo = miniMap.getContainer().querySelector('.maplibregl-ctrl-logo');
                    if (logo) logo.style.display = 'none';
                });

                // –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî fallback
                miniMap.on('error', (e) => {
                    console.warn('Mini-map warning (non-fatal):', e);
                });

            } catch (e) {
                console.error('Mini-map init failed:', e);
                mapDiv.innerHTML = `
                    <div class="h-100 d-flex flex-column">
                        <div class="flex-grow-1 bg-light d-flex align-items-center justify-content-center">
                            <div class="text-center p-3">
                                <div class="text-muted mb-2">üìç</div>
                                <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}"
                                  target="_blank"
                                  class="btn btn-sm btn-outline-secondary">
                                    –û—Ç–∫—Ä—ã—Ç—å –≤ OpenStreetMap
                                </a>
                            </div>
                        </div>
                        <div class="px-3 py-2 small text-muted border-top bg-light">
                            <code>${lng.toFixed(6)}, ${lat.toFixed(6)}</code>
                        </div>
                    </div>
                `;
            }
        });

        // –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
        function toggleVote(issueId, intendedValue, isUpvoted, isDownvoted) {
            let voteValue = null;
            if (intendedValue === 1 && isUpvoted) {
                voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
            } else if (intendedValue === -1 && isDownvoted) {
                voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
            } else {
                voteValue = intendedValue.toString();
            }

            const formData = new FormData();
            const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
            formData.append('csrfmiddlewaretoken', csrf);
            formData.append('vote', voteValue);

            const upBtn = document.querySelector(`.upvote-btn[data-issue-id="${issueId}"]`);
            const downBtn = document.querySelector(`.downvote-btn[data-issue-id="${issueId}"]`);
            if (upBtn && downBtn) {
                upBtn.disabled = true;
                downBtn.disabled = true;
            }

            fetch(`/issues/${issueId}/vote/`, {
                method: 'POST',
                body: formData,
                redirect: 'follow',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(r => r.json().then(data => r.ok ? data : Promise.reject(data)))
            .then(data => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥
                const ratingElement = document.querySelector('.rating-value');
                if (ratingElement) {
                    ratingElement.textContent = data.rating;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
                if (upBtn) {
                    upBtn.classList.toggle('active', data.user_vote === 1);
                }
                if (downBtn) {
                    downBtn.classList.toggle('active', data.user_vote === -1);
                }
            })
            .catch(err => {
                console.error('Vote error:', err);
                alert(err.error || '{% trans "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è." %}');
            })
            .finally(() => {
                if (upBtn) upBtn.disabled = false;
                if (downBtn) downBtn.disabled = false;
            });
        }
    </script>
{% endblock %}