{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="container mt-4">
  <h1 class="h3 mb-1">{{ issue.title }}</h1>
  <p class="text-muted small mb-4">
    {{ issue.created_at|date:"d.m.Y H:i" }} ¬∑
    {{ issue.get_category_display }} ¬∑
    <span class="badge bg-light text-dark border">{{ issue.get_status_display }}</span>
  </p>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}</h5>
          <div class="bg-light p-3 rounded mb-4" style="min-height: 120px;">
            <p class="mb-0" style="white-space: pre-wrap;">{{ issue.description|default:"‚Äî" }}</p>
          </div>

          <!-- –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ -->
          <div class="d-flex align-items-center justify-content-between mt-4 pt-3 border-top">
            <div>
              <span class="h5 mb-0" data-issue-id="{{ issue.id }}" id="rating-value">{{ issue.vote_rating }}</span>
              <span class="text-muted ms-1">{% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}</span>
            </div>

            {% if user.is_authenticated and user.role == 'citizen' %}
              <div class="btn-group" role="group">
                <button type="button"
                        class="btn btn-sm {% if issue.user_has_upvoted %}btn-success{% else %}btn-outline-success{% endif %}"
                        onclick="toggleVote({{ issue.id }}, 1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                  üëç
                </button>
                <button type="button"
                        class="btn btn-sm {% if issue.user_has_downvoted %}btn-danger{% else %}btn-outline-danger{% endif %}"
                        onclick="toggleVote({{ issue.id }}, -1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                  üëé
                </button>
              </div>
            {% endif %}
          </div>

          {% if issue.photos.all %}
          <h5 class="mb-3 mt-4">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã" %}</h5>
          <div class="row g-2 mb-4">
            {% for photo in issue.photos.all %}
            <div class="col-6 col-md-4 col-lg-3">
              <a href="{{ photo.image.url }}" target="_blank" class="d-block text-center">
                <img src="{{ photo.image.url }}" class="img-fluid rounded"
                     alt="–§–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã {{ forloop.counter }}"
                     style="max-height: 150px; object-fit: cover; width: 100%;">
                <small class="d-block mt-1 text-muted">{{ forloop.counter }}/{{ issue.photos.count }}</small>
              </a>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          <h5 class="mb-3 mt-4">{% trans "–î–µ—Ç–∞–ª–∏" %}</h5>
          <dl class="row mb-0">
            <dt class="col-sm-4 text-muted small">{% trans "–ê–≤—Ç–æ—Ä" %}</dt>
            <dd class="col-sm-8">
              {% if user.is_authenticated and user.role == 'official' %}
                {{ issue.reporter.get_full_name }} 
                {% if issue.reporter.email %}({{ issue.reporter.email }}){% endif %}
              {% else %}
                {{ issue.reporter.get_full_name }}
              {% endif %}
            </dd>
            <dt class="col-sm-4 text-muted small">{% trans "–°—Ç–∞—Ç—É—Å" %}</dt>
            <dd class="col-sm-8">{{ issue.get_status_display }}</dd>
            <dt class="col-sm-4 text-muted small">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</dt>
            <dd class="col-sm-8">{{ issue.get_category_display }}</dd>
            <dt class="col-sm-4 text-muted small">{% trans "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" %}</dt>
            <dd class="col-sm-8">
              <code>{{ issue.location.x|floatformat:6 }}, {{ issue.location.y|floatformat:6 }}</code>
            </dd>
            <dt class="col-sm-4 text-muted small">{% trans "–†–µ–π—Ç–∏–Ω–≥" %}</dt>
            <dd class="col-sm-8">
              <span class="badge bg-primary">{{ issue.vote_rating }}</span>
              {% if user.is_authenticated and user.role == 'citizen' %}
                <small class="text-muted ms-1">
                  {% if issue.user_has_upvoted %}
                    ({% trans "–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ üëç" %})
                  {% elif issue.user_has_downvoted %}
                    ({% trans "–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ üëé" %})
                  {% else %}
                    ({% trans "–í—ã –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏" %})
                  {% endif %}
                </small>
              {% endif %}
            </dd>
            <dt class="col-sm-4 text-muted small">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %}</dt>
            <dd class="col-sm-8">{{ issue.photos.count }}</dd>
          </dl>
        </div>
      </div>

      <!-- Comment Section -->
      <div class="card mt-4">
        <div class="card-header bg-light py-2">
          <h5 class="mb-0">{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" %} ({{ issue.comments.count }})</h5>
        </div>
        <div class="card-body">
          {% if issue.comments.exists %}
            <div class="comments-list mb-4">
              {% for comment in issue.comments.all %}
                <div class="d-flex mb-3 pb-3 border-bottom">
                  <div class="flex-shrink-0 me-3">
                    {% if comment.author.profile_picture %}
                      <img src="{{ comment.author.profile_picture.url }}" class="rounded-circle" width="40" height="40" alt="Avatar">
                    {% else %}
                      <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                           style="width:40px; height:40px; font-weight:500;">
                        {{ comment.author.first_name.0 }}{{ comment.author.last_name.0 }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <div>
                        <strong class="me-2">{{ comment.author.get_full_name }}</strong>
                        <span class="badge bg-{% if comment.author.role == 'citizen' %}secondary{% else %}info{% endif %} ms-1">
                          {{ comment.author.get_role_display }}
                        </span>
                      </div>
                      <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    <p class="mb-0 mt-1">{{ comment.text }}</p>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted text-center py-4">{% trans "–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!" %}</p>
          {% endif %}

          {% if user.is_authenticated %}
            <form method="post" action="{% url 'issues:issue_detail' issue.pk %}" class="mt-3">
              {% csrf_token %}
              <div class="mb-3">
                {{ comment_form.text }}
              </div>
              <button type="submit" class="btn btn-primary">
                ‚û§ {% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" %}
              </button>
              <small class="text-muted d-block mt-1">
                {% if user.role == 'citizen' %}
                  {% trans "–í—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ –∫–∞–∫ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω" %}
                {% else %}
                  {% trans "–í—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ª–∏—Ü–æ" %}
                {% endif %}
              </small>
            </form>
          {% else %}
            <div class="alert alert-info mt-3">
              <i class="bi bi-info-circle me-1"></i>
              {% trans "–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" %}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="mt-4">
        <a href="{% url 'issues:map' %}" class="btn btn-secondary">
          ‚Üê {% trans "–ö –∫–∞—Ä—Ç–µ" %}
        </a>

        {% if user.is_authenticated and user.role == 'official' %}
          <form method="post" action="{% url 'issues:delete_issue' issue.id %}"
                onsubmit="return confirm('{% trans "‚ùó –£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." %}');"
                class="d-inline ms-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
              {% trans "–£–¥–∞–ª–∏—Ç—å" %}
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header py-2">
          <h6 class="mb-0 small text-uppercase text-muted">{% trans "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" %}</h6>
        </div>
        <div class="card-body p-0">
          <div id="mini-map" style="height: 240px; width: 100%;"></div>
        </div>
      </div>

      {% if issue.photos.all %}
      <div class="card mt-4">
        <div class="card-header py-2">
          <h6 class="mb-0 small text-uppercase text-muted">{% trans "–û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ" %}</h6>
        </div>
        <div class="card-body text-center">
          <a href="{{ issue.photos.first.image.url }}" target="_blank">
            <img src="{{ issue.photos.first.image.url }}" class="img-fluid rounded"
                 alt="–û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã"
                 style="max-height: 200px; object-fit: contain; width: 100%;">
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- MapLibre GL -->
<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mapDiv = document.getElementById('mini-map');
    if (!mapDiv) return;

    const lng = {{ issue.location.x|floatformat:6 }};
    const lat = {{ issue.location.y|floatformat:6 }};

    try {
      const miniMap = new maplibregl.Map({
        container: 'mini-map',
        style: {
          version: 8,
          sources: {
            'osm-de': {
              type: 'raster',
              tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
              tileSize: 256,
              attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }
          },
          layers: [{
            id: 'osm-de-tiles',
            type: 'raster',
            source: 'osm-de',
            minzoom: 0,
            maxzoom: 19
          }]
        },
        center: [lng, lat],
        zoom: 14,
        interactive: false,
        attributionControl: true
      });

      // –ú–∞—Ä–∫–µ—Ä
      new maplibregl.Marker({ color: '#e74c3c' })
        .setLngLat([lng, lat])
        .addTo(miniMap);

      // –£–±–∏—Ä–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø MapLibre
      miniMap.on('load', () => {
        const logo = miniMap.getContainer().querySelector('.maplibregl-ctrl-logo');
        if (logo) logo.style.display = 'none';
      });

      // –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî fallback
      miniMap.on('error', (e) => {
        console.warn('Mini-map warning (non-fatal):', e);
      });

    } catch (e) {
      console.error('Mini-map init failed:', e);
      mapDiv.innerHTML = `
        <div class="h-100 d-flex flex-column">
          <div class="flex-grow-1 bg-light d-flex align-items-center justify-content-center">
            <div class="text-center p-3">
              <div class="text-muted mb-2">üìç</div>
              <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}"
                 target="_blank"
                 class="btn btn-sm btn-outline-secondary">
                –û—Ç–∫—Ä—ã—Ç—å –≤ OpenStreetMap
              </a>
            </div>
          </div>
          <div class="px-3 py-2 small text-muted border-top bg-light">
            <code>${lng.toFixed(6)}, ${lat.toFixed(6)}</code>
          </div>
        </div>
      `;
    }
  });
</script>

<!-- CSRF –¥–ª—è JS -->
{% csrf_token %}

<!-- JS: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–º–µ–Ω–æ–π -->
<script>
function toggleVote(issueId, intendedValue, isUpvoted, isDownvoted) {
    let voteValue = null;
    if (intendedValue === 1 && isUpvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else if (intendedValue === -1 && isDownvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else {
        voteValue = intendedValue.toString();
    }

    const formData = new FormData();
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrf);
    formData.append('vote', voteValue);

    const buttons = document.querySelectorAll(`button[onclick*="toggleVote(${issueId},"]`);
    buttons.forEach(b => { b.disabled = true; b.innerHTML = '‚ãØ'; });

    fetch(`/issues/${issueId}/vote/`, {
        method: 'POST',
        body: formData,
        redirect: 'follow',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json().then(data => r.ok ? data : Promise.reject(data)))
    .then(data => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥
        const ratingElement = document.getElementById('rating-value');
        if (ratingElement) {
            ratingElement.textContent = data.rating;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
        const up = document.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = document.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up && down) {
            up.classList.toggle('btn-success', data.user_vote === 1);
            up.classList.toggle('btn-outline-success', data.user_vote !== 1);
            down.classList.toggle('btn-danger', data.user_vote === -1);
            down.classList.toggle('btn-outline-danger', data.user_vote !== -1);
        }
    })
    .catch(err => {
        console.error('Vote error:', err);
        alert(err.error || '{% trans "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è." %}');
    })
    .finally(() => {
        const up = document.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = document.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up) up.innerHTML = 'üëç'; if (down) down.innerHTML = 'üëé';
        if (up) up.disabled = false; if (down) down.disabled = false;
    });
}
</script>

{% endblock %}