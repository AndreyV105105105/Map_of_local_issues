{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ issue.title }} - {% trans "Детали проблемы" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/issue_detail.css' %}">
    <link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <div class="issue-detail-container">
        <div class="issue-header">
            <h1 class="issue-title">{{ issue.title }}</h1>
            <div class="issue-meta">
                <span class="meta-date">{{ issue.created_at|date:"d.m.Y H:i" }}</span>
                <span class="meta-separator">·</span>
                <span class="meta-category">{{ issue.get_category_display }}</span>
                <span class="meta-separator">·</span>
                <span class="issue-status-badge status-{{ issue.status }}">{{ issue.get_status_display }}</span>
            </div>
        </div>

        <div class="issue-content-grid">
            <main class="issue-main-content">
                <section class="issue-description">
                    <h3>{% trans "Описание проблемы" %}</h3>
                    <div class="description-content">
                        <p>{{ issue.description|default:"—" }}</p>
                    </div>
                </section>

                {% if issue.photos.all %}
                <section class="issue-photos">
                    <h3>{% trans "Фотографии проблемы" %}</h3>
                    <div class="photos-grid">
                        {% for photo in issue.photos.all %}
                        <div class="photo-item">
                            <img src="{{ photo.image.url }}" alt="Фото проблемы {{ forloop.counter }}">
                            <div class="photo-caption">
                                <span>{{ forloop.counter }}/{{ issue.photos.count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <section class="issue-voting">
                    <div class="voting-header">
                        <span class="rating-value" data-issue-id="{{ issue.id }}">{{ issue.vote_rating }}</span>
                        <span class="rating-label">{% trans "рейтинг" %}</span>
                    </div>

                    {% if user.is_authenticated and user.role == 'citizen' %}
                        <div class="vote-buttons">
                            <button type="button" 
                                    class="vote-btn upvote-btn {% if issue.user_has_upvoted %}active{% endif %}"
                                    data-issue-id="{{ issue.id }}"
                                    data-direction="1"
                                    onclick="toggleVote({{ issue.id }}, 1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                                <img src="{% static 'icons/like.svg' %}" alt="Нравится">
                            </button>
                            <button type="button" 
                                    class="vote-btn downvote-btn {% if issue.user_has_downvoted %}active{% endif %}"
                                    data-issue-id="{{ issue.id }}"
                                    data-direction="-1"
                                    onclick="toggleVote({{ issue.id }}, -1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                                <img src="{% static 'icons/dislike.svg' %}" alt="Не нравится">
                            </button>
                        </div>
                    {% endif %}
                </section>

                <section class="issue-details">
                    <h3>{% trans "Детали проблемы" %}</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Автор" %}</span>
                            <span class="detail-value">
                                {% if user.is_authenticated and user.role == 'official' %}
                                    {{ issue.reporter.get_full_name }} 
                                    {% if issue.reporter.email %}({{ issue.reporter.email }}){% endif %}
                                {% else %}
                                    {{ issue.reporter.get_full_name }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Статус" %}</span>
                            <span class="detail-value">{{ issue.get_status_display }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Категория" %}</span>
                            <span class="detail-value">{{ issue.get_category_display }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Адрес" %}</span>
                            <span class="detail-value">{{ issue.address|default:"—" }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Координаты" %}</span>
                            <span class="detail-value coordinates">
                                {{ issue.location.x|floatformat:6 }}, {{ issue.location.y|floatformat:6 }}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Рейтинг" %}</span>
                            <span class="detail-value">
                                <span class="rating-badge">{{ issue.vote_rating }}</span>
                                {% if user.is_authenticated and user.role == 'citizen' %}
                                    <small class="user-vote-status">
                                        {% if issue.user_has_upvoted %}
                                            ({% trans "Вы проголосовали за" %})
                                        {% elif issue.user_has_downvoted %}
                                            ({% trans "Вы проголосовали против" %})
                                        {% else %}
                                            ({% trans "Вы не голосовали" %})
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">{% trans "Фотографии" %}</span>
                            <span class="detail-value">{{ issue.photos.count }}</span>
                        </div>
                    </div>
                </section>

                <!-- Comment Section -->
                <section class="issue-comments">
                    <h3>{% trans "Комментарии" %} ({{ issue.comments.count }})</h3>
                    
                    <div class="comments-list">
                        {% if issue.comments.exists %}
                            {% for comment in issue.comments.all %}
                                <div class="comment-item">
                                    <div class="comment-avatar">
                                        {% if comment.author.profile_picture %}
                                            <img src="{{ comment.author.profile_picture.url }}" alt="Avatar" width="40" height="40">
                                        {% else %}
                                            <div class="avatar-placeholder">
                                                {{ comment.author.first_name.0|default:"A" }}{{ comment.author.last_name.0|default:"U" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="comment-content">
                                        <div class="comment-header">
                                            <div class="comment-author-info">
                                                <strong>{{ comment.author.get_full_name }}</strong>
                                                <span class="comment-role {% if comment.author.role == 'official' %}role-official{% endif %}">
                                                    {{ comment.author.get_role_display }}
                                                </span>
                                            </div>
                                            <small class="comment-time">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                        </div>
                                        <p class="comment-text">{{ comment.text }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-comments">{% trans "Пока нет комментариев. Станьте первым!" %}</p>
                        {% endif %}
                    </div>

                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'issues:issue_detail' issue.pk %}" class="comment-form">
                            {% csrf_token %}
                            <div class="form-group">
                                {{ comment_form.text }}
                            </div>
                            <button type="submit" class="btn btn-primary">
                                {% trans "Отправить комментарий" %}
                            </button>
                            <small class="form-text">
                                {% if user.role == 'citizen' %}
                                    {% trans "Вы комментируете как гражданин" %}
                                {% else %}
                                    {% trans "Вы комментируете как официальное лицо" %}
                                {% endif %}
                            </small>
                        </form>
                    {% else %}
                        <div class="alert alert-info">
                            {% trans "Войдите в аккаунт, чтобы оставить комментарий" %}
                        </div>
                    {% endif %}
                </section>

                <div class="issue-actions">
                    <a href="{% url 'issues:map' %}" class="btn btn-secondary">
                        ← {% trans "Вернуться к карте" %}
                    </a>

                    {% if user.is_authenticated and user.role == 'official' %}
                        <form method="post" action="{% url 'issues:delete_issue' issue.id %}"
                              onsubmit="return confirm('{% trans "Удалить обращение? Действие нельзя отменить." %}');"
                              class="delete-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                {% trans "Удалить проблему" %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </main>

            <aside class="issue-sidebar">
                <div class="location-card">
                    <h4>{% trans "Местоположение" %}</h4>
                    <div id="mini-map" class="map-container"></div>
                </div>

                {% if issue.photos.all %}
                <div class="main-photo-card">
                    <h4>{% trans "Основное фото" %}</h4>
                    <div class="main-photo-container">
                        <a href="{{ issue.photos.first.image.url }}" target="_blank">
                            <img src="{{ issue.photos.first.image.url }}" alt="Основное фото проблемы">
                        </a>
                    </div>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closePhotoModal()">&times;</span>
            <img id="modalImage" src="" alt="Увеличенное фото">
            <div class="modal-counter" id="modalCounter"></div>
            <div class="modal-nav">
                <button class="modal-nav-btn prev" onclick="navigatePhoto('prev')"><</button>
                <button class="modal-nav-btn next" onclick="navigatePhoto('next')">></button>
            </div>
        </div>
    </div>

    {% csrf_token %}
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
    <script src="{% static 'issue_detail.js' %}"></script>
{% endblock %}