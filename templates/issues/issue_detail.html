{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="container mt-4">
  <h1 class="h3 mb-1">{{ issue.title }}</h1>
  <p class="text-muted small mb-4">
    {{ issue.created_at|date:"d.m.Y H:i" }} ¬∑ 
    {{ issue.get_category_display }} ¬∑ 
    <span class="badge bg-light text-dark border">{{ issue.get_status_display }}</span>
  </p>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}</h5>
          <div class="bg-light p-3 rounded mb-4" style="min-height: 120px;">
            <p class="mb-0" style="white-space: pre-wrap;">{{ issue.description|default:"‚Äî" }}</p>
          </div>

          <!-- –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ -->
          <div class="d-flex align-items-center justify-content-between mt-4 pt-3 border-top">
            <div>
              <span class="h5 mb-0">{{ issue.vote_rating }}</span>
              <span class="text-muted ms-1">{% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}</span>
            </div>

            {% if user.is_authenticated and user.role == 'citizen' %}
              <div class="btn-group" role="group">
                <button type="button"
                        class="btn btn-sm {% if issue.user_has_upvoted %}btn-success{% else %}btn-outline-success{% endif %}"
                        onclick="toggleVote({{ issue.id }}, 1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                  üëç
                </button>
                <button type="button"
                        class="btn btn-sm {% if issue.user_has_downvoted %}btn-danger{% else %}btn-outline-danger{% endif %}"
                        onclick="toggleVote({{ issue.id }}, -1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                  üëé
                </button>
              </div>
            {% endif %}
          </div>

          <h5 class="mb-3 mt-4">{% trans "–î–µ—Ç–∞–ª–∏" %}</h5>
          <dl class="row mb-0">
            <dt class="col-sm-4 text-muted small">{% trans "–ê–≤—Ç–æ—Ä" %}</dt>
            <dd class="col-sm-8">{{ issue.reporter.get_full_name|default:issue.reporter.email }}</dd>
            <dt class="col-sm-4 text-muted small">{% trans "–°—Ç–∞—Ç—É—Å" %}</dt>
            <dd class="col-sm-8">{{ issue.get_status_display }}</dd>
            <dt class="col-sm-4 text-muted small">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</dt>
            <dd class="col-sm-8">{{ issue.get_category_display }}</dd>
            <dt class="col-sm-4 text-muted small">{% trans "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" %}</dt>
            <dd class="col-sm-8">
              <code>{{ issue.location.x|floatformat:6 }}, {{ issue.location.y|floatformat:6 }}</code>
            </dd>
            <dt class="col-sm-4 text-muted small">{% trans "–†–µ–π—Ç–∏–Ω–≥" %}</dt>
            <dd class="col-sm-8">
              <span class="badge bg-primary">{{ issue.vote_rating }}</span>
              {% if user.is_authenticated and user.role == 'citizen' %}
                <small class="text-muted ms-1">
                  {% if issue.user_has_upvoted %}
                    ({% trans "–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ üëç" %})
                  {% elif issue.user_has_downvoted %}
                    ({% trans "–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ üëé" %})
                  {% else %}
                    ({% trans "–í—ã –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏" %})
                  {% endif %}
                </small>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>

      <div class="mt-4">
        <a href="{% url 'issues:map' %}" class="btn btn-secondary">
          ‚Üê {% trans "–ö –∫–∞—Ä—Ç–µ" %}
        </a>

        {% if user.is_authenticated and user.role == 'official' %}
          <form method="post" action="{% url 'issues:delete_issue' issue.id %}"
                onsubmit="return confirm('{% trans "‚ùó –£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." %}');"
                class="d-inline ms-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
              {% trans "–£–¥–∞–ª–∏—Ç—å" %}
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header py-2">
          <h6 class="mb-0 small text-uppercase text-muted">{% trans "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" %}</h6>
        </div>
        <div class="card-body p-0">
          <div id="mini-map" style="height: 240px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MapLibre GL -->
<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mapDiv = document.getElementById('mini-map');
    if (!mapDiv) return;

    const lng = {{ issue.location.x|floatformat:6 }};
    const lat = {{ issue.location.y|floatformat:6 }};

    try {
      const miniMap = new maplibregl.Map({
        container: 'mini-map',
        style: {
          version: 8,
          sources: {
            'osm-de': {
              type: 'raster',
              tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
              tileSize: 256,
              attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }
          },
          layers: [{
            id: 'osm-de-tiles',
            type: 'raster',
            source: 'osm-de',
            minzoom: 0,
            maxzoom: 19
          }]
        },
        center: [lng, lat],
        zoom: 14,
        interactive: false,
        attributionControl: true
      });

      new maplibregl.Marker({ color: '#e74c3c' })
        .setLngLat([lng, lat])
        .addTo(miniMap);

      miniMap.on('load', () => {
        const logo = miniMap.getContainer().querySelector('.maplibregl-ctrl-logo');
        if (logo) logo.style.display = 'none';
      });
    } catch (e) {
      console.error('Mini-map init failed:', e);
      mapDiv.innerHTML = `
        <div class="h-100 d-flex flex-column">
          <div class="flex-grow-1 bg-light d-flex align-items-center justify-content-center">
            <div class="text-center p-3">
              <div class="text-muted mb-2">üìç</div>
              <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}"
                 target="_blank"
                 class="btn btn-sm btn-outline-secondary">
                –û—Ç–∫—Ä—ã—Ç—å –≤ OpenStreetMap
              </a>
            </div>
          </div>
          <div class="px-3 py-2 small text-muted border-top bg-light">
            <code>${lng.toFixed(6)}, ${lat.toFixed(6)}</code>
          </div>
        </div>
      `;
    }
  });
</script>

<!-- CSRF –¥–ª—è JS -->
{% csrf_token %}

<!-- JS: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–º–µ–Ω–æ–π -->
<script>
function toggleVote(issueId, intendedValue, isUpvoted, isDownvoted) {
    let voteValue = null;
    if (intendedValue === 1 && isUpvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else if (intendedValue === -1 && isDownvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else {
        voteValue = intendedValue.toString();
    }

    const formData = new FormData();
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrf);
    formData.append('vote', voteValue);

    const buttons = document.querySelectorAll(`button[onclick*="toggleVote(${issueId},"]`);
    buttons.forEach(b => { b.disabled = true; b.innerHTML = '‚ãØ'; });

    fetch(`/issues/${issueId}/vote/`, {
        method: 'POST',
        body: formData,
        redirect: 'follow',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json().then(data => r.ok ? data : Promise.reject(data)))
    .then(data => {
        // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–π—Ç–∏–Ω–≥–∞ —Å –Ω—É–∂–Ω—ã–º data-issue-id
        document.querySelectorAll(`.rating-value[data-issue-id="${issueId}"]`).forEach(el => {
            if (el.classList.contains('h5')) {
                el.textContent = data.rating;
            } else {
                el.textContent = data.rating + ' {% trans "–≥–æ–ª–æ—Å–æ–≤" %}';
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
        const up = document.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = document.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up && down) {
            up.classList.toggle('btn-success', data.user_vote === 1);
            up.classList.toggle('btn-outline-success', data.user_vote !== 1);
            down.classList.toggle('btn-danger', data.user_vote === -1);
            down.classList.toggle('btn-outline-danger', data.user_vote !== -1);
        }
    })
    .catch(err => {
        console.error('Vote error:', err);
        alert(err.error || '{% trans "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è." %}');
    })
    .finally(() => {
        const up = document.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = document.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up) up.innerHTML = 'üëç'; if (down) down.innerHTML = 'üëé';
        if (up) up.disabled = false; if (down) down.disabled = false;
    });
}
</script>

{% endblock %}