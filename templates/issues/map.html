{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="{% static 'css/map.css' %}"> <!-- –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–∞–π–ª—É -->
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ MapLibre GL -->
    <link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="map-header">
  <h2>{% trans "–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫)" %}</h2>

  {% if user.is_authenticated and user.role == 'citizen' %}
    <div class="map-instruction">
      <p>{% trans "–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏." %}
    </div>
  {% endif %}
</div>

<!-- –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É ‚Äî –ø–æ–≤–µ—Ä—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç—ã -->
<div class="map-search-container">
  <div class="input-group map-search-input-group">
    <input type="text" id="map-address-search" class="form-control map-search-input"
          placeholder="{% trans '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å: –õ–µ–Ω–∏–Ω–∞, –ú–∏—Ä–∞, –ù–µ—Ñ—Ç—è–Ω–∏–∫–æ–≤...' %}">
    <button class="map-search-btn" type="button" id="map-search-btn">
      <i class="bi bi-search"></i> 
    </button>
  </div>
  <div id="map-search-results" class="map-search-results"></div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
<div id="map-container">
    <div id="map"></div>
</div>

<div class="container mt-4">
  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
  <div class="map-filters-container">
    <h5>{% trans "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π" %}</h5>
    <form id="filter-form" class="map-filter-row">
      <div class="map-filter-item">
        <label for="category-filter" class="form-label small">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
        <select id="category-filter" name="category" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" %}</option>
          {% for value, label in categories %}
            <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="map-filter-item">
        <label for="status-filter" class="form-label small">{% trans "–°—Ç–∞—Ç—É—Å" %}</label>
        <select id="status-filter" name="status" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" %}</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="map-filter-item">
        <label for="search-filter" class="form-label small">{% trans "–ü–æ–∏—Å–∫" %}</label>
        <input type="text" id="search-filter" name="search" class="form-control form-control-sm"
              placeholder="{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä..." %}" value="{{ search_query }}">
      </div>

      <div class="map-filter-item">
        <label for="sort-filter" class="form-label small">{% trans "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" %}</label>
        <select id="sort-filter" name="sort" class="form-select form-select-sm">
          <option value="-created_at" {% if selected_sort == "-created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" %}</option>
          <option value="created_at" {% if selected_sort == "created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ" %}</option>
          <option value="-vote_rating" {% if selected_sort == "-vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="vote_rating" {% if selected_sort == "vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="title" {% if selected_sort == "title" %}selected{% endif %}>{% trans "–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é" %}</option>
        </select>
      </div>

      <div class="map-filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}</button>
        <button type="button" id="reset-filters" class="btn btn-secondary btn-sm">{% trans "–°–±—Ä–æ—Å–∏—Ç—å" %}</button>
      </div>
    </form>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    {% if selected_category or selected_status or search_query %}
    <div class="map-active-filters">
      <small class="text-muted">{% trans "–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:" %}</small>
      {% if selected_category %}
        <span class="badge bg-info filter-badge" data-filter="category">
          {% for value, label in categories %}
            {% if value == selected_category %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if selected_status %}
        <span class="badge bg-warning filter-badge" data-filter="status">
          {% for value, label in status_choices %}
            {% if value == selected_status %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if search_query %}
        <span class="badge bg-success filter-badge" data-filter="search">{{ search_query }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
  <div id="issues-container">
    {% include "issues/partials/issues_list.html" %}
  </div>
</div>


{% csrf_token %}


<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />

<script>
  const bounds = [
    [68.75, 60.75],
    [69.30, 61.15]
  ];

  let markers = [];
  let tempMarker = null;

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'osm': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }
      },
      layers: [{
        id: 'osm-tiles',
        type: 'raster',
        source: 'osm',
        minzoom: 0,
        maxzoom: 19
      }]
    },
    center: [69.0179, 61.0034],
    zoom: 12,
    maxBounds: bounds
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.addControl(new maplibregl.ScaleControl({ maxWidth: 100 }), 'bottom-left');

  // === –ú–ê–†–ö–ï–†–´ –ò –§–ò–õ–¨–¢–†–´ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ===
  function updateMapMarkers(filters) {
    markers.forEach(marker => marker.remove());
    markers = [];

    fetch(`/issues/map/geojson/?${new URLSearchParams(filters)}`)
    .then(response => {
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        return response.json();
    })
    .then(geojson => {
        geojson.features.forEach(feature => {
            const lng = feature.geometry.coordinates[0];
            const lat = feature.geometry.coordinates[1];
            const props = feature.properties;

            if (!isNaN(lng) && !isNaN(lat)) {
                const popupContent = `
                    <a href="${props.url}"
                       style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                        ${props.title}
                    </a>
                    <small>
                        –°—Ç–∞—Ç—É—Å: <strong>${props.status_display}</strong><br>
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${props.category_display}<br>
                        –†–µ–π—Ç–∏–Ω–≥: <strong>${props.vote_rating}</strong>
                        ${props.photos_count > 0 ? `<br>üì∏ ${props.photos_count} {% trans "—Ñ–æ—Ç–æ" %}` : ''}
                    </small>
                `;

                const popup = new maplibregl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    anchor: 'top',
                    offset: [0, -8],
                    maxWidth: '220px'
                }).setHTML(popupContent);

                const marker = new maplibregl.Marker({ color: '#e74c3c' })
                    .setLngLat([lng, lat])
                    .setPopup(popup)
                    .addTo(map);

                const markerEl = marker.getElement();
                if (markerEl) {
                    markerEl.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        popup.addTo(map);
                    });
                    markerEl.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        if (popup.isOpen()) popup.remove();
                    });

                    markerEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = props.url;
                    });
                }

                markers.push(marker);
            }
        });
    })
    .catch(error => {
        console.error('Error updating map markers:', error);
        setTimeout(() => {
            markers.forEach(marker => marker.remove());
            markers = [];
            {% for issue in issues %}
              {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
                {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
                  {% if lng != "None" and lat != "None" %}
                    {
                      const lng = parseFloat("{{ lng }}");
                      const lat = parseFloat("{{ lat }}");
                      if (!isNaN(lng) && !isNaN(lat)) {
                        const popup = new maplibregl.Popup({
                          closeButton: false,
                          closeOnClick: false,
                          anchor: 'top',
                          offset: [0, -8],
                          maxWidth: '220px'
                        }).setHTML(`
                          <a href="{% url 'issues:issue_detail' issue.id %}"
                             style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                            {{ issue.title|escapejs }}
                          </a>
                          <small>
                            –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                            –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                            {% if issue.photos.all %}
                              <br> {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                            {% endif %}
                          </small>
                        `);

                        const marker = new maplibregl.Marker({ color: '#e74c3c' })
                          .setLngLat([lng, lat])
                          .addTo(map);

                        const markerEl = marker.getElement();
                        if (markerEl) {
                          markerEl.addEventListener('mouseenter', (e) => {
                            e.stopPropagation();
                            popup.setLngLat(marker.getLngLat()).addTo(map);
                          });
                          markerEl.addEventListener('mouseleave', (e) => {
                            e.stopPropagation();
                            if (popup.isOpen()) popup.remove();
                          });

                          markerEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                          });
                        }

                        markers.push(marker);
                      }
                    }
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% endfor %}
        }, 500);
    });
  }

  function loadIssuesWithFilters(filters) {
    const url = new URL(window.location.href);
    Object.entries(filters).forEach(([key, value]) => {
      value ? url.searchParams.set(key, value) : url.searchParams.delete(key);
    });
    history.pushState({}, '', url);

    const btn = document.querySelector('#filter-form button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

    fetch(`/issues/map/?${new URLSearchParams(filters)}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      return response.text();
    })
    .then(html => {
      document.getElementById('issues-container').innerHTML = html;
      updateMapMarkers(filters);
    })
    .catch(error => {
      console.error('Error loading filtered issues:', error);
      alert('{% trans "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." %}');
    })
    .finally(() => {
      const btn = document.querySelector('#filter-form button[type="submit"]');
      btn.disabled = false;
      btn.innerHTML = '{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}';
    });
  }

  document.getElementById('filter-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const filters = Object.fromEntries(formData.entries());
    loadIssuesWithFilters(filters);
  });

  document.getElementById('reset-filters')?.addEventListener('click', function() {
    ['category-filter', 'status-filter', 'search-filter', 'sort-filter'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = el.id === 'sort-filter' ? '-created_at' : '';
    });
    document.querySelectorAll('.filter-badge').forEach(el => el.remove());
    
    const formData = new FormData(document.getElementById('filter-form'));
    loadIssuesWithFilters(Object.fromEntries(formData.entries()));
  });

  document.querySelectorAll('.filter-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const f = this.dataset.filter;
      const el = document.getElementById(f + '-filter');
      if (el) el.value = '';
      this.remove();
      const formData = new FormData(document.getElementById('filter-form'));
      loadIssuesWithFilters(Object.fromEntries(formData.entries()));
    });
  });

  let searchTimeout;
  document.getElementById('search-filter')?.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    if (e.target.value.length > 2 || e.target.value.length === 0) {
      searchTimeout = setTimeout(() => {
        const formData = new FormData(document.getElementById('filter-form'));
        loadIssuesWithFilters(Object.fromEntries(formData.entries()));
      }, 500);
    }
  });

  // === –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï –ü–û –ê–î–†–ï–°–£ ===
  function clearSearchResults() {
    const div = document.getElementById('map-search-results');
    if (div) { div.innerHTML = ''; div.style.display = 'none'; }
  }

  function showSearchResults(results) {
    const div = document.getElementById('map-search-results');
    if (!div) return;
    div.innerHTML = '';
    if (!results || results.length === 0) return clearSearchResults();

    results.forEach(r => {
      const item = document.createElement('div');
      item.className = 'map-search-result-item';
      const road = r.address?.road || '';
      const city = r.address?.city || r.address?.town || '';
      const sub = [road, city].filter(Boolean).join(', ') || '';
      item.innerHTML = `<div><strong>${r.display_name}</strong></div><small class="text-muted">${sub}</small>`;
      item.onclick = () => {
        const lat = r.lat, lon = r.lon, addr = r.display_name;
        map.flyTo({ center: [lon, lat], zoom: 16 });
        clearSearchResults();
        if (tempMarker) tempMarker.remove();
        tempMarker = new maplibregl.Marker({ color: '#3498db' })
          .setLngLat([lon, lat])
          .setPopup(new maplibregl.Popup().setText(addr))
          .addTo(map);
        tempMarker.togglePopup();
        if ({% if user.is_authenticated and user.role == 'citizen' %}true{% else %}false{% endif %}) {
          showReportButton(lat, lon, addr);
        }
      };
      div.appendChild(item);
    });
    div.style.display = 'block';
  }

  let searchDebounce;
  const searchInput = document.getElementById('map-address-search');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchDebounce);
      const q = this.value.trim();
      if (q.length < 2) return clearSearchResults();
      searchDebounce = setTimeout(async () => {
        try {
          const res = await fetch(`/issues/api/search-address/?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          showSearchResults(data.results);
        } catch (e) {
          console.warn('Search failed:', e);
          clearSearchResults();
        }
      }, 300);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const div = document.getElementById('map-search-results');
        const first = div?.querySelector('.map-search-result-item');
        if (first) first.click();
        else if (searchInput.value.trim()) searchInput.dispatchEvent(new Event('input'));
      }
    });
  }

  document.getElementById('map-search-btn')?.addEventListener('click', () => {
    if (searchInput) searchInput.dispatchEvent(new Event('input'));
  });

  document.addEventListener('click', e => {
    const container = document.querySelector('.map-search-container');
    if (container && !container.contains(e.target)) clearSearchResults();
  });

  // === –ö–ù–û–ü–ö–ê ¬´–°–û–û–ë–©–ò–¢–¨¬ª ===
  function showReportButton(lat, lon, address) {
    const old = document.getElementById('map-report-btn');
    if (old) old.remove();

    const btn = Object.assign(document.createElement('button'), {
      id: 'map-report-btn',
      className: 'btn btn-success btn-sm',
      innerHTML: ' {% trans "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ –∑–¥–µ—Å—å" %}',
      style: 'position:absolute;top:10px;right:10px;z-index:2'
    });

    btn.onclick = () => {
      const url = new URL('{% url "issues:create_issue" %}', location.origin);
      url.searchParams.set('lat', lat.toFixed(6));
      url.searchParams.set('lon', lon.toFixed(6));
      url.searchParams.set('address', address);
      location.href = url.toString();
    };

    document.getElementById('map').appendChild(btn);
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  const userIsCitizen = {% if user.is_authenticated and user.role == 'citizen' %}true{% else %}false{% endif %};

  map.on('load', () => {
    // –ú–∞—Ä–∫–µ—Ä—ã (—É–∂–µ –µ—Å—Ç—å –≤—ã—à–µ ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º)
    {% for issue in issues %}
      {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
        {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
          {% if lng != "None" and lat != "None" %}
            {
              const lng = parseFloat("{{ lng }}");
              const lat = parseFloat("{{ lat }}");
              if (!isNaN(lng) && !isNaN(lat)) {
                const popup = new maplibregl.Popup({
                  closeButton: false,
                  closeOnClick: false,
                  anchor: 'top',
                  offset: [0, -8],
                  maxWidth: '220px'
                }).setHTML(`
                  <a href="{% url 'issues:issue_detail' issue.id %}"
                     style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                    {{ issue.title|escapejs }}
                  </a>
                  <small>
                    –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                    –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                    {% if issue.photos.all %}
                      <br> {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                    {% endif %}
                  </small>
                `);
                const marker = new maplibregl.Marker({ color: '#e74c3c' }).setLngLat([lng, lat]).addTo(map);
                const el = marker.getElement();
                if (el) {
                  el.addEventListener('mouseenter', () => popup.setLngLat(marker.getLngLat()).addTo(map));
                  el.addEventListener('mouseleave', () => popup.isOpen() && popup.remove());
                  el.addEventListener('click', () => location.href = "{% url 'issues:issue_detail' issue.id %}");
                }
                markers.push(marker);
              }
            }
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –æ–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞
    if (userIsCitizen) {
        map.on('click', async function(e) {
          if (e.originalEvent.target.closest('.maplibregl-marker, .maplibregl-popup')) return;
        
          const lng = e.lngLat.lng;
          const lat = e.lngLat.lat;
        
          // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
          let address = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          try {
            const resp = await fetch(`/issues/api/reverse-geocode/?lat=${lat}&lon=${lng}`);
            const data = await resp.json();
            if (data.address) {
              address = data.address;
            }
          } catch (err) {
            console.warn('Reverse geocode failed:', err);
        }

        if (tempMarker) tempMarker.remove();
        tempMarker = new maplibregl.Marker({ color: '#3498db' })
          .setLngLat([lng, lat])
          .setPopup(new maplibregl.Popup().setText(address))
          .addTo(map);
        tempMarker.togglePopup();

        showReportButton(lat, lng, address);
      });
    }
  });

  map.on('error', e => {
    console.error('Map error:', e);
    document.getElementById('map').innerHTML =
      `<div class="alert alert-danger p-3"> –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: ${e.error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
  });
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
{% if user.is_authenticated and user.role == 'citizen' %}
<div id="modal-backdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999;"></div>
<div id="report-form-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; width:90%; max-width:500px;">
  <h5>{% trans "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ" %}</h5>
  <form method="post" action="{% url 'issues:create_issue' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" id="id_lat" name="lat">
    <input type="hidden" id="id_lon" name="lon">
    <div class="mb-3"><label class="form-label">{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ" %}</label><input type="text" name="title" class="form-control" required></div>
    <div class="mb-3"><label class="form-label">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}</label><textarea name="description" class="form-control" rows="3" required></textarea></div>
    <div class="mb-3"><label class="form-label">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
      <select name="category" class="form-select" required>
        {% for value, label in categories %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="modal-images" class="form-label">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %} (–¥–æ 5, JPG/PNG, –º–∞–∫—Å. 5MB)</label>
      <input type="file" class="form-control" id="modal-images" name="images" multiple accept="image/jpeg, image/png">
      <div id="modal-preview" class="mt-2 d-flex flex-wrap gap-1"></div>
      <small class="form-text text-muted">{% trans "–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤" %}</small>
    </div>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-secondary me-2"
              onclick="document.getElementById('report-form-modal').style.display='none';document.getElementById('modal-backdrop').style.display='none';if (typeof tempMarker !== 'undefined' && tempMarker !== null) { tempMarker.remove(); tempMarker = null; }">
        {% trans "–û—Ç–º–µ–Ω–∞" %}
      </button>
      <button type="submit" class="btn btn-success">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const inp = document.getElementById('modal-images');
    if (!inp) return;
    inp.addEventListener('change', function() {
      const preview = document.getElementById('modal-preview');
      preview.innerHTML = '';
      if (this.files.length > 5) alert('{% trans "–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ë—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5." %}');
      Array.from(this.files).slice(0, 5).forEach(file => {
        if (file.size > 5 * 1024 * 1024) return preview.appendChild(Object.assign(document.createElement('div'), { className: 'text-danger small mt-1', textContent: `‚ö†Ô∏è ${file.name} {% trans "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π" %}` }));
        if (!file.type.match('image.*')) return preview.appendChild(Object.assign(document.createElement('div'), { className: 'text-danger small mt-1', textContent: `‚ö†Ô∏è ${file.name} {% trans "–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" %}` }));
        const reader = new FileReader();
        reader.onload = e => {
          const img = Object.assign(document.createElement('img'), {
            src: e.target.result,
            style: 'width:60px;height:60px;object-fit:cover;border-radius:4px;border:1px solid #ddd'
          });
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
  });
</script>
{% endif %}

<script src="{% static 'js/map.js' %}"></script> 

{% endblock %}