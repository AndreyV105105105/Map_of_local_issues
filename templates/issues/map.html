{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container mt-4">
  <h2>{% trans "–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫)" %}</h2>

  {% if user.is_authenticated and user.role == 'citizen' %}
    <div class="alert alert-info">
      {% trans "–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Å–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ." %}
    </div>
  {% endif %}

  <div id="map" style="height: 600px; width: 100%; border: 1px solid #ccc; border-radius: 4px;"></div>

  <div class="mt-4">
    <h4>{% trans "–í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è" %} ({{ issues.count }})</h4>
    {% for issue in issues %}
      <div class="card mb-3" data-issue-id="{{ issue.id }}">
        <div class="card-body">
          <h6 class="mb-1">
            <a href="{% url 'issues:issue_detail' issue.id %}" class="text-decoration-none text-dark">
              {{ issue.title }}
            </a>
          </h6>

          <!-- –†–µ–π—Ç–∏–Ω–≥ –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ -->
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-primary rounded-pill px-2 me-2">
              {{ issue.vote_rating }} {% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}
            </span>

            {% if user.is_authenticated and user.role == 'citizen' %}
              <div class="btn-group" role="group">
                <button type="button"
                        class="btn btn-sm {% if issue.user_has_upvoted %}btn-success{% else %}btn-outline-success{% endif %}"
                        onclick="toggleVote({{ issue.id }}, 1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                  üëç
                </button>
                <button type="button"
                        class="btn btn-sm {% if issue.user_has_downvoted %}btn-danger{% else %}btn-outline-danger{% endif %}"
                        onclick="toggleVote({{ issue.id }}, -1, {{ issue.user_has_upvoted|yesno:'true,false' }}, {{ issue.user_has_downvoted|yesno:'true,false' }})">
                  üëé
                </button>
              </div>
            {% endif %}
          </div>

          <p class="text-muted small mb-1">
            {{ issue.description|truncatewords:15 }}
          </p>
          <p class="text-muted small mb-0">
            {% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}: {{ issue.get_category_display }} |
            {% trans "–°—Ç–∞—Ç—É—Å" %}: {{ issue.get_status_display }} |
            {% trans "–ê–≤—Ç–æ—Ä" %}: {{ issue.reporter.email }} |
            {{ issue.created_at|date:"d.m.Y H:i" }}
          </p>

          {% if issue.photos.all %}
            <div class="mt-2">
              <div class="d-flex flex-wrap gap-1">
                {% for photo in issue.photos.all|slice:":3" %}
                  <a href="{{ photo.image.url }}" target="_blank" title="{% trans "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ" %}">
                    <img src="{{ photo.image.url }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                  </a>
                {% endfor %}
                {% if issue.photos.count > 3 %}
                  <span class="badge bg-secondary align-self-center">+{{ issue.photos.count|add:"-3" }}</span>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {% if user.is_authenticated and user.role == 'official' %}
            <div class="mt-2">
              <form method="post" action="{% url 'issues:update_issue_status' issue.id %}" class="d-inline">
                {% csrf_token %}
                <select name="status" class="form-select form-select-sm d-inline w-auto" style="width: auto; display: inline-block; margin-right: 5px;">
                  {% for key, label in issue.STATUS_CHOICES %}
                    <option value="{{ key }}" {% if issue.status == key %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary">{% trans "–û–±–Ω–æ–≤–∏—Ç—å" %}</button>
              </form>

              <form method="post" action="{% url 'issues:delete_issue' issue.id %}"
                    onsubmit="return confirm('‚ùó –£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ ¬´{{ issue.title|escapejs }}¬ª? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');"
                    class="d-inline ms-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  üóëÔ∏è {% trans "–£–¥–∞–ª–∏—Ç—å" %}
                </button>
              </form>
            </div>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p>{% trans "–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π." %}</p>
    {% endfor %}
  </div>
</div>

<!-- MapLibre GL -->
<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />

<script>
  const bounds = [
    [68.75, 60.75],
    [69.30, 61.15]
  ];

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'osm': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }
      },
      layers: [{
        id: 'osm-tiles',
        type: 'raster',
        source: 'osm',
        minzoom: 0,
        maxzoom: 19
      }]
    },
    center: [69.0179, 61.0034],
    zoom: 12,
    maxBounds: bounds
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.addControl(new maplibregl.ScaleControl({ maxWidth: 100 }), 'bottom-left');

  map.on('load', () => {
    {% for issue in issues %}
      {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
        {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
          {% if lng != "None" and lat != "None" %}
            {
              const lng = parseFloat("{{ lng }}");
              const lat = parseFloat("{{ lat }}");
              if (!isNaN(lng) && !isNaN(lat)) {
                const popup = new maplibregl.Popup({
                  closeButton: false,
                  closeOnClick: false,
                  anchor: 'top',
                  offset: [0, -8],
                  maxWidth: '220px'
                }).setHTML(`
                  <a href="{% url 'issues:issue_detail' issue.id %}"
                     style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                    {{ issue.title|escapejs }}
                  </a>
                  <small>
                    –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                    –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                    {% if issue.photos.all %}
                      <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                    {% endif %}
                  </small>
                `);

                const marker = new maplibregl.Marker({ color: '#e74c3c' })
                  .setLngLat([lng, lat])
                  .addTo(map);

                const markerEl = marker.getElement();
                if (markerEl) {
                  markerEl.addEventListener('mouseenter', (e) => {
                    e.stopPropagation();
                    popup.setLngLat(marker.getLngLat()).addTo(map);
                  });
                  markerEl.addEventListener('mouseleave', (e) => {
                    e.stopPropagation();
                    if (popup.isOpen()) popup.remove();
                  });

                  markerEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                  });
                }
              }
            }
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    {% if user.is_authenticated and user.role == 'citizen' %}
      let tempMarker = null;
      map.on('click', function(e) {
        const clickedOnMarker = e.originalEvent.target.closest('.maplibregl-marker');
        if (clickedOnMarker) return;

        const lng = e.lngLat.lng.toFixed(6);
        const lat = e.lngLat.lat.toFixed(6);

        if (tempMarker) tempMarker.remove();

        tempMarker = new maplibregl.Marker({ color: '#3498db' })
          .setLngLat([lng, lat])
          .setPopup(new maplibregl.Popup().setText("{% trans '–ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–æ–±—â–∏—Ç—å¬ª –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å' %}"))
          .addTo(map);

        tempMarker.togglePopup();

        const latInput = document.getElementById('id_lat');
        const lonInput = document.getElementById('id_lon');
        if (latInput) latInput.value = lat;
        if (lonInput) lonInput.value = lng;

        const modal = document.getElementById('report-form-modal');
        const backdrop = document.getElementById('modal-backdrop');
        if (modal && backdrop) {
          modal.style.display = 'block';
          backdrop.style.display = 'block';
        }
      });
    {% endif %}
  });

  map.on('error', (e) => {
    console.error('Map error:', e);
    document.getElementById('map').innerHTML =
      `<div class="alert alert-danger p-3">‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: ${e.error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
  });
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω -->
{% if user.is_authenticated and user.role == 'citizen' %}
<div id="modal-backdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999;"></div>
<div id="report-form-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; width:90%; max-width:500px;">
  <h5>{% trans "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ" %}</h5>
  <form method="post" action="{% url 'issues:create_issue' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" id="id_lat" name="lat">
    <input type="hidden" id="id_lon" name="lon">
    <div class="mb-3"><label class="form-label">{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ" %}</label><input type="text" name="title" class="form-control" required></div>
    <div class="mb-3"><label class="form-label">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}</label><textarea name="description" class="form-control" rows="3" required></textarea></div>
    <div class="mb-3"><label class="form-label">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
      <select name="category" class="form-select" required>
        {% for value, label in categories %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
    <div class="mb-3">
      <label for="modal-images" class="form-label">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %} (–¥–æ 5, JPG/PNG, –º–∞–∫—Å. 5MB)</label>
      <input type="file" class="form-control" id="modal-images" name="images" multiple accept="image/jpeg, image/png">
      <div id="modal-preview" class="mt-2 d-flex flex-wrap gap-1"></div>
      <small class="form-text text-muted">{% trans "–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤" %}</small>
    </div>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-secondary me-2"
              onclick="document.getElementById('report-form-modal').style.display='none';document.getElementById('modal-backdrop').style.display='none';if (typeof tempMarker !== 'undefined' && tempMarker !== null) { tempMarker.remove(); tempMarker = null; }">
        {% trans "–û—Ç–º–µ–Ω–∞" %}
      </button>
      <button type="submit" class="btn btn-success">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
    </div>
  </form>
</div>

<script>
  // –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('modal-images');
    if (imageInput) {
      imageInput.addEventListener('change', function() {
        const preview = document.getElementById('modal-preview');
        preview.innerHTML = '';  // –û—á–∏—Å—Ç–∫–∞

        if (this.files.length > 5) {
          alert('{% trans "–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ë—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5." %}');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const filesToShow = Array.from(this.files).slice(0, 5);

        filesToShow.forEach(file => {
          if (file.size > 5 * 1024 * 1024) {
            const warning = document.createElement('div');
            warning.className = 'text-danger small mt-1';
            warning.textContent = `‚ö†Ô∏è ${file.name} {% trans "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)" %}`;
            preview.appendChild(warning);
            return;
          }

          if (!file.type.match('image.*')) {
            const warning = document.createElement('div');
            warning.className = 'text-danger small mt-1';
            warning.textContent = `‚ö†Ô∏è ${file.name} {% trans "–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º" %}`;
            preview.appendChild(warning);
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            img.style.border = '1px solid #ddd';
            img.title = file.name;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });
    }
  });
</script>
{% endif %}

<!-- CSRF –¥–ª—è JS -->
{% csrf_token %}

<!-- JS: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–º–µ–Ω–æ–π -->
<script>
function toggleVote(issueId, intendedValue, isUpvoted, isDownvoted) {
    let voteValue = null;
    if (intendedValue === 1 && isUpvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else if (intendedValue === -1 && isDownvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else {
        voteValue = intendedValue.toString();
    }

    const formData = new FormData();
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrf);
    formData.append('vote', voteValue);

    // –ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø—Ä–æ–±–ª–µ–º–æ–π
    const card = document.querySelector(`.card[data-issue-id="${issueId}"]`);
    if (!card) return;

    const buttons = card.querySelectorAll(`button[onclick*="toggleVote(${issueId},"]`);
    buttons.forEach(b => { b.disabled = true; b.innerHTML = '‚ãØ'; });

    fetch(`/issues/${issueId}/vote/`, {
        method: 'POST',
        body: formData,
        redirect: 'follow',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json().then(data => r.ok ? data : Promise.reject(data)))
    .then(data => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
        const ratingBadge = card.querySelector('.badge.bg-primary');
        if (ratingBadge) {
            ratingBadge.innerHTML = `${data.rating} {% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ popup –Ω–∞ –∫–∞—Ä—Ç–µ
        document.querySelectorAll('.maplibregl-popup-content').forEach(popup => {
            if (popup.innerHTML.includes(`/issues/${issueId}/`)) {
                const ratingElement = popup.querySelector('small');
                if (ratingElement) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º
                    ratingElement.innerHTML = ratingElement.innerHTML.replace(
                        /–†–µ–π—Ç–∏–Ω–≥: <strong>\d+<\/strong>/,
                        `–†–µ–π—Ç–∏–Ω–≥: <strong>${data.rating}</strong>`
                    );
                }
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
        const up = card.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = card.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up && down) {
            up.classList.toggle('btn-success', data.user_vote === 1);
            up.classList.toggle('btn-outline-success', data.user_vote !== 1);
            down.classList.toggle('btn-danger', data.user_vote === -1);
            down.classList.toggle('btn-outline-danger', data.user_vote !== -1);
        }
    })
    .catch(err => {
        console.error('Vote error:', err);
        alert(err.error || '{% trans "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è." %}');
    })
    .finally(() => {
        const up = card.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = card.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up) up.innerHTML = 'üëç'; if (down) down.innerHTML = 'üëé';
        if (up) up.disabled = false; if (down) down.disabled = false;
    });
}
</script>

{% endblock %}