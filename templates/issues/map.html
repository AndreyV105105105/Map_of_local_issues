{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<style>
  .map-page-header {
    margin-bottom: 24px;
  }
  
  .map-page-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-color);
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  
  .map-alert {
    background-color: var(--card-bg);
    border: 1px solid var(--primary-color);
    border-radius: 16px;
    padding: 16px 20px;
    color: var(--text-color);
    margin-bottom: 24px;
  }
  
  .map-wrapper-container {
    position: relative;
    margin-bottom: 32px;
  }
  
  .filter-container {
    background-color: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    margin-bottom: 24px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .filter-container h5 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    text-transform: uppercase;
    color: var(--text-color);
  }
  
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
  }
  
  .filter-item {
    flex: 1;
    min-width: 180px;
  }
  
  .filter-item label {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 8px;
    display: block;
    font-size: 14px;
  }
  
  .filter-item .form-select,
  .filter-item .form-control {
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    padding: 10px 14px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  
  .filter-item .form-select:focus,
  .filter-item .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(231, 90, 124, 0.1);
    outline: none;
  }
  
  .filter-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    align-items: flex-end;
  }
  
  .filter-actions .btn {
    border-radius: 50px;
    padding: 10px 24px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 14px;
    transition: all 0.3s;
    border: none;
  }
  
  .filter-actions .btn-primary {
    background-color: var(--primary-color);
    color: white;
  }
  
  .filter-actions .btn-primary:hover {
    background-color: #d14a6c;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 90, 124, 0.3);
  }
  
  .filter-actions .btn-outline-secondary {
    background-color: white;
    color: var(--text-color);
    border: 2px solid var(--primary-color);
  }
  
  .filter-actions .btn-outline-secondary:hover {
    background-color: var(--primary-color);
    color: white;
  }
  
  .filter-badge {
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .filter-badge:hover {
    opacity: 0.8;
    transform: scale(1.05);
  }
  
  .filter-badge.bg-info {
    background-color: var(--primary-color) !important;
    color: white;
  }
  
  .filter-badge.bg-warning {
    background-color: #ffa726 !important;
    color: white;
  }
  
  .filter-badge.bg-success {
    background-color: #66bb6a !important;
    color: white;
  }
  
  #map {
    height: 600px;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.05);
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
  .map-search-container {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2;
    width: 500px;
    max-width: 90vw;
  }
  
  .map-search-input-group {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 50px;
    overflow: hidden;
    background: white;
    display: flex;
    align-items: center;
    border: 2px solid var(--primary-color);
  }
  
  .map-search-input {
    border: none;
    padding: 12px 20px;
    font-size: 14px;
    outline: none;
    flex: 1;
    background: transparent;
  }
  
  .map-search-input::placeholder {
    color: var(--light-text);
  }
  
  .map-search-btn {
    background: var(--primary-color);
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    color: white;
    transition: background-color 0.3s;
  }
  
  .map-search-btn:hover {
    background-color: #d14a6c;
  }
  
  .map-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--primary-color);
    border-top: none;
    border-radius: 0 0 16px 16px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1001;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: -2px;
  }
  
  .map-search-results-header {
    padding: 12px 20px;
    background-color: var(--primary-color);
    color: white;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .map-search-results-count {
    background-color: rgba(255, 255, 255, 0.25);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
  }
  
  .map-search-result-item {
    padding: 16px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  
  .map-search-result-item:hover {
    background-color: var(--card-bg);
    padding-left: 24px;
  }
  
  .map-search-result-item.active {
    background-color: var(--card-bg);
    border-left: 3px solid var(--primary-color);
    padding-left: 17px;
  }
  
  .map-search-result-item:last-child {
    border-bottom: none;
  }
  
  .map-search-result-icon {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    margin-top: 2px;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .map-search-result-icon svg {
    width: 20px;
    height: 20px;
  }
  
  .map-search-result-content {
    flex: 1;
    min-width: 0;
  }
  
  .map-search-result-main {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 6px;
    line-height: 1.4;
    font-size: 15px;
  }
  
  .map-search-result-details {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  
  .map-search-result-detail {
    font-size: 12px;
    color: var(--light-text);
    background-color: #f8f8f8;
    padding: 4px 8px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .map-search-result-detail-icon {
    width: 12px;
    height: 12px;
    color: var(--primary-color);
  }
  
  .map-search-result-address {
    font-size: 13px;
    color: var(--light-text);
    line-height: 1.5;
    margin-top: 4px;
    word-break: break-word;
  }
  
  .map-search-no-results {
    padding: 32px 20px;
    text-align: center;
    color: var(--light-text);
  }
  
  .map-search-no-results-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }
  
  .map-search-no-results-text {
    font-size: 14px;
    font-weight: 500;
  }
  
  .map-search-results::-webkit-scrollbar {
    width: 8px;
  }
  
  .map-search-results::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .map-search-results::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 4px;
  }
  
  .map-search-results::-webkit-scrollbar-thumb:hover {
    background: #d14a6c;
  }
  
  #map-report-btn {
    background-color: var(--primary-color) !important;
    color: white !important;
    border: none !important;
    border-radius: 50px !important;
    padding: 12px 24px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    font-size: 14px !important;
    box-shadow: 0 4px 12px rgba(231, 90, 124, 0.3) !important;
    transition: all 0.3s !important;
    max-width: 280px;
    white-space: normal;
    word-wrap: break-word;
    text-align: center;
    line-height: 1.3;
  }
  
  #map-report-btn:hover {
    background-color: #d14a6c !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(231, 90, 124, 0.4) !important;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è popup –∫–∞—Ä—Ç—ã */
  .maplibregl-popup-content {
    border-radius: 12px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    padding: 16px !important;
    max-width: 250px !important;
  }
  
  .maplibregl-popup-content a {
    color: var(--primary-color) !important;
    font-weight: 600 !important;
  }
  
  .maplibregl-popup-content a:hover {
    color: #d14a6c !important;
  }
  
  .maplibregl-popup-tip {
    border-top-color: white !important;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ */
  .maplibregl-marker {
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  .maplibregl-marker:hover {
    transform: scale(1.1);
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π */
  #issues-container {
    margin-top: 32px;
  }
  
  #issues-container h4 {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 24px;
    text-transform: uppercase;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--primary-color);
  }
  
  #issues-container .card {
    background-color: var(--card-bg);
    border: 1px solid rgba(0,0,0,0.05);
    border-radius: 16px;
    padding: 0;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: all 0.3s;
    overflow: hidden;
  }
  
  #issues-container .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  #issues-container .card-body {
    padding: 24px;
  }
  
  /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è */
  #issues-container .issue-description {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-color);
    margin-bottom: 14px;
    font-weight: 400;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: calc(1.6em * 3);
  }
  
  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ –≤–Ω–∏–∑—É */
  #issues-container .issue-photos-container {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(0,0,0,0.08);
  }
  
  #issues-container .issue-photos-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    width: 100%;
  }
  
  /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Ñ–æ—Ç–æ –≤–∏–¥–Ω—ã */
  #issues-container .issue-photos-grid > * {
    min-width: 0;
  }
  
  #issues-container .issue-photo-link {
    display: block;
    text-decoration: none;
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    background-color: white;
  }
  
  #issues-container .issue-photo-link:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  #issues-container .issue-photo-thumbnail {
    width: 100%;
    height: 100px;
    min-height: 100px;
    object-fit: cover;
    display: block;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    background-color: #f5f5f5;
  }
  
  #issues-container .issue-photo-link:hover .issue-photo-thumbnail {
    transform: scale(1.05);
    border: 2px solid var(--primary-color);
  }
  
  #issues-container .issue-photo-more {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100px;
    min-height: 100px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--card-bg) 0%, rgba(231, 90, 124, 0.1) 100%);
    border: 2px dashed var(--primary-color);
    transition: all 0.3s;
  }
  
  #issues-container .issue-photo-more:hover {
    background: linear-gradient(135deg, rgba(231, 90, 124, 0.1) 0%, rgba(231, 90, 124, 0.2) 100%);
    border-color: #d14a6c;
  }
  
  #issues-container .issue-photo-more .badge {
    font-size: 13px;
    padding: 8px 14px;
    background-color: var(--primary-color) !important;
    color: white;
    font-weight: 600;
  }
  
  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
  @media (max-width: 992px) {
    #issues-container .issue-photos-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  @media (max-width: 768px) {
    #issues-container .issue-photos-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    #issues-container .issue-photo-thumbnail {
      height: 80px;
      min-height: 80px;
    }
    
    #issues-container .issue-photo-more {
      height: 80px;
      min-height: 80px;
    }
  }
  
  @media (max-width: 480px) {
    #issues-container .issue-photos-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    #issues-container .issue-photo-thumbnail {
      height: 70px;
      min-height: 70px;
    }
    
    #issues-container .issue-photo-more {
      height: 70px;
      min-height: 70px;
    }
  }
  
  #issues-container .card h6 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 14px;
    line-height: 1.4;
  }
  
  #issues-container .card h6 a {
    color: var(--text-color);
    text-decoration: none;
    transition: color 0.2s;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  #issues-container .card h6 a:hover {
    color: var(--primary-color);
  }
  
  #issues-container .badge.bg-primary {
    background-color: var(--primary-color) !important;
    color: white;
    font-size: 14px;
    font-weight: 600;
    padding: 7px 14px;
    border-radius: 50px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  /* –†–µ–π—Ç–∏–Ω–≥ –∏ –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è */
  #issues-container .d-flex.align-items-center {
    display: flex !important;
    align-items: center !important;
    flex-wrap: wrap;
    gap: 12px !important;
  }
  
  #issues-container .d-flex.align-items-center > .badge {
    margin-right: 0 !important;
  }
  
  #issues-container .btn-group {
    gap: 6px !important;
    display: flex !important;
    flex-shrink: 0;
    margin-left: 0 !important;
    border-radius: 0;
    box-shadow: none;
  }
  
  #issues-container .btn-group > .btn {
    margin-left: 0 !important;
    border-radius: 8px !important;
  }
  
  #issues-container .btn-group .btn {
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 18px;
    line-height: 1;
    transition: all 0.2s;
    border: 2px solid;
    min-width: 44px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Segoe UI Emoji', 'Segoe UI Symbol', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
  }
  
  #issues-container .btn-group .btn::before {
    content: '';
    display: none;
  }
  
  #issues-container .btn-group .btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(231, 90, 124, 0.2);
  }
  
  #issues-container .btn-group .btn-success,
  #issues-container .btn-group .btn-outline-success {
    border-color: #66bb6a;
  }
  
  #issues-container .btn-group .btn-success {
    background-color: #66bb6a;
    color: white;
  }
  
  #issues-container .btn-group .btn-outline-success {
    background-color: transparent;
    color: #66bb6a;
  }
  
  #issues-container .btn-group .btn-success:hover {
    background-color: #4caf50;
    transform: scale(1.05);
  }
  
  #issues-container .btn-group .btn-outline-success:hover {
    background-color: #66bb6a;
    color: white;
  }
  
  #issues-container .btn-group .btn-danger,
  #issues-container .btn-group .btn-outline-danger {
    border-color: #ef5350;
  }
  
  #issues-container .btn-group .btn-danger {
    background-color: #ef5350;
    color: white;
  }
  
  #issues-container .btn-group .btn-outline-danger {
    background-color: transparent;
    color: #ef5350;
  }
  
  #issues-container .btn-group .btn-danger:hover {
    background-color: #e53935;
    transform: scale(1.05);
  }
  
  #issues-container .btn-group .btn-outline-danger:hover {
    background-color: #ef5350;
    color: white;
  }
  
  #issues-container .text-muted {
    color: var(--light-text) !important;
    font-size: 15px;
    line-height: 1.6;
  }
  
  #issues-container .text-muted.small {
    font-size: 15px;
  }
  
  #issues-container .card-body > p.text-muted.small:first-of-type {
    font-size: 16px;
    margin-bottom: 14px;
    color: var(--text-color) !important;
    font-weight: 500;
    line-height: 1.5;
  }
  
  #issues-container .card-body > p.text-muted.small:last-of-type {
    font-size: 15px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0,0,0,0.08);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  
  #issues-container .card-body > p.text-muted.small:last-of-type::before {
    content: '';
    display: none;
  }
  
  #issues-container .img-thumbnail {
    border-radius: 8px;
    border: 2px solid rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }
  
  #issues-container .img-thumbnail:hover {
    transform: scale(1.1);
    border-color: var(--primary-color);
  }
  
  #issues-container .badge.bg-secondary {
    background-color: var(--primary-color) !important;
    color: white;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
  }
  
  #issues-container p:last-child {
    margin-bottom: 0;
  }
  
  /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
  #issues-container .issue-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  
  #issues-container .issue-meta-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 15px;
    color: var(--light-text);
  }
  
  #issues-container .issue-meta-separator {
    color: var(--light-text);
    opacity: 0.5;
    font-size: 15px;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
  #issues-container > p {
    text-align: center;
    padding: 48px 20px;
    color: var(--light-text);
    font-size: 16px;
    background-color: var(--card-bg);
    border-radius: 16px;
    border: 2px dashed var(--primary-color);
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ª–∏—Ü) */
  #issues-container .form-select-sm {
    border-radius: 8px;
    border: 2px solid var(--primary-color);
    font-size: 13px;
    padding: 6px 12px;
  }
  
  #issues-container .form-select-sm:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(231, 90, 124, 0.1);
    outline: none;
  }
  
  #issues-container .btn-outline-primary,
  #issues-container .btn-outline-danger {
    border-radius: 8px;
    font-size: 13px;
    padding: 6px 16px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  #issues-container .btn-outline-primary {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }
  
  #issues-container .btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-1px);
  }
  
  #issues-container .btn-outline-danger {
    border-color: #ef5350;
    color: #ef5350;
  }
  
  #issues-container .btn-outline-danger:hover {
    background-color: #ef5350;
    color: white;
    transform: translateY(-1px);
  }
  
  /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
  #issues-container {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  #issues-container strong {
    font-weight: 600;
    color: var(--text-color);
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="map-page-header">
  <h2>{% trans "–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫)" %}</h2>

  {% if user.is_authenticated and user.role == 'citizen' %}
      <div class="map-alert">
      {% trans "–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏." %}
    </div>
  {% endif %}
  </div>
</div>

<!-- –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É ‚Äî –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã -->
<div class="map-wrapper-container">
<div class="map-search-container">
  <div class="input-group map-search-input-group">
    <input type="text" id="map-address-search" class="form-control map-search-input"
           placeholder="{% trans '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å: –õ–µ–Ω–∏–Ω–∞, –ú–∏—Ä–∞, –ù–µ—Ñ—Ç—è–Ω–∏–∫–æ–≤...' %}">
    <button class="map-search-btn" type="button" id="map-search-btn">
      <i class="bi bi-search"></i>
    </button>
  </div>
  <div id="map-search-results" class="map-search-results" style="display:none;"></div>
</div>

  <div id="map"></div>
</div>

<div class="container">
  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
  <div class="filter-container">
    <h5 class="mb-3">{% trans "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π" %}</h5>
    <form id="filter-form" class="filter-row">
      <div class="filter-item">
        <label for="category-filter" class="form-label small">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
        <select id="category-filter" name="category" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" %}</option>
          {% for value, label in categories %}
            <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-item">
        <label for="status-filter" class="form-label small">{% trans "–°—Ç–∞—Ç—É—Å" %}</label>
        <select id="status-filter" name="status" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" %}</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-item">
        <label for="search-filter" class="form-label small">{% trans "–ü–æ–∏—Å–∫" %}</label>
        <input type="text" id="search-filter" name="search" class="form-control form-control-sm"
               placeholder="{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä..." %}" value="{{ search_query }}">
      </div>

      <div class="filter-item">
        <label for="sort-filter" class="form-label small">{% trans "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" %}</label>
        <select id="sort-filter" name="sort" class="form-select form-select-sm">
          <option value="-created_at" {% if selected_sort == "-created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" %}</option>
          <option value="created_at" {% if selected_sort == "created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ" %}</option>
          <option value="-vote_rating" {% if selected_sort == "-vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="vote_rating" {% if selected_sort == "vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="title" {% if selected_sort == "title" %}selected{% endif %}>{% trans "–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é" %}</option>
        </select>
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}</button>
        <button type="button" id="reset-filters" class="btn btn-outline-secondary btn-sm">{% trans "–°–±—Ä–æ—Å–∏—Ç—å" %}</button>
      </div>
    </form>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    {% if selected_category or selected_status or search_query %}
    <div class="mt-3">
      <small class="text-muted">{% trans "–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:" %}</small>
      {% if selected_category %}
        <span class="badge bg-info filter-badge me-1" data-filter="category">
          {% for value, label in categories %}
            {% if value == selected_category %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if selected_status %}
        <span class="badge bg-warning filter-badge me-1" data-filter="status">
          {% for value, label in status_choices %}
            {% if value == selected_status %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if search_query %}
        <span class="badge bg-success filter-badge me-1" data-filter="search">{{ search_query }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
  <div id="issues-container">
    {% include "issues/partials/issues_list.html" %}
  </div>
</div>

<!-- MapLibre GL -->
<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />

<script>
  const bounds = [
    [68.75, 60.75],
    [69.30, 61.15]
  ];

  let markers = [];
  let tempMarker = null;

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'osm': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }
      },
      layers: [{
        id: 'osm-tiles',
        type: 'raster',
        source: 'osm',
        minzoom: 0,
        maxzoom: 19
      }]
    },
    center: [69.0179, 61.0034],
    zoom: 12,
    maxBounds: bounds
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.addControl(new maplibregl.ScaleControl({ maxWidth: 100 }), 'bottom-left');

  // === –ú–ê–†–ö–ï–†–´ –ò –§–ò–õ–¨–¢–†–´ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ===
  function updateMapMarkers(filters) {
    markers.forEach(marker => marker.remove());
    markers = [];

    fetch(`/issues/map/geojson/?${new URLSearchParams(filters)}`)
    .then(response => {
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        return response.json();
    })
    .then(geojson => {
        geojson.features.forEach(feature => {
            const lng = feature.geometry.coordinates[0];
            const lat = feature.geometry.coordinates[1];
            const props = feature.properties;

            if (!isNaN(lng) && !isNaN(lat)) {
                const popupContent = `
                    <a href="${props.url}"
                       style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                        ${props.title}
                    </a>
                    <small>
                        –°—Ç–∞—Ç—É—Å: <strong>${props.status_display}</strong><br>
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${props.category_display}<br>
                        –†–µ–π—Ç–∏–Ω–≥: <strong>${props.vote_rating}</strong>
                        ${props.photos_count > 0 ? `<br>üì∏ ${props.photos_count} {% trans "—Ñ–æ—Ç–æ" %}` : ''}
                    </small>
                `;

                const popup = new maplibregl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    anchor: 'top',
                    offset: [0, -8],
                    maxWidth: '220px'
                }).setHTML(popupContent);

                const marker = new maplibregl.Marker({ color: '#E75A7C' })
                    .setLngLat([lng, lat])
                    .setPopup(popup)
                    .addTo(map);

                const markerEl = marker.getElement();
                if (markerEl) {
                    markerEl.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        popup.addTo(map);
                    });
                    markerEl.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        if (popup.isOpen()) popup.remove();
                    });

                    markerEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = props.url;
                    });
                }

                markers.push(marker);
            }
        });
    })
    .catch(error => {
        console.error('Error updating map markers:', error);
        setTimeout(() => {
            markers.forEach(marker => marker.remove());
            markers = [];
            {% for issue in issues %}
              {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
                {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
                  {% if lng != "None" and lat != "None" %}
                    {
                      const lng = parseFloat("{{ lng }}");
                      const lat = parseFloat("{{ lat }}");
                      if (!isNaN(lng) && !isNaN(lat)) {
                        const popup = new maplibregl.Popup({
                          closeButton: false,
                          closeOnClick: false,
                          anchor: 'top',
                          offset: [0, -8],
                          maxWidth: '220px'
                        }).setHTML(`
                          <a href="{% url 'issues:issue_detail' issue.id %}"
                             style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                            {{ issue.title|escapejs }}
                          </a>
                          <small>
                            –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                            –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                            {% if issue.photos.all %}
                              <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                            {% endif %}
                          </small>
                        `);

                        const marker = new maplibregl.Marker({ color: '#E75A7C' })
                          .setLngLat([lng, lat])
                          .addTo(map);

                        const markerEl = marker.getElement();
                        if (markerEl) {
                          markerEl.addEventListener('mouseenter', (e) => {
                            e.stopPropagation();
                            popup.setLngLat(marker.getLngLat()).addTo(map);
                          });
                          markerEl.addEventListener('mouseleave', (e) => {
                            e.stopPropagation();
                            if (popup.isOpen()) popup.remove();
                          });

                          markerEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                          });
                        }

                        markers.push(marker);
                      }
                    }
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% endfor %}
        }, 500);
    });
  }

  function loadIssuesWithFilters(filters) {
    const url = new URL(window.location.href);
    Object.entries(filters).forEach(([key, value]) => {
      value ? url.searchParams.set(key, value) : url.searchParams.delete(key);
    });
    history.pushState({}, '', url);

    const btn = document.querySelector('#filter-form button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

    fetch(`/issues/map/?${new URLSearchParams(filters)}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      return response.text();
    })
    .then(html => {
      document.getElementById('issues-container').innerHTML = html;
      updateMapMarkers(filters);
    })
    .catch(error => {
      console.error('Error loading filtered issues:', error);
      alert('{% trans "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." %}');
    })
    .finally(() => {
      const btn = document.querySelector('#filter-form button[type="submit"]');
      btn.disabled = false;
      btn.innerHTML = '{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}';
    });
  }

  document.getElementById('filter-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const filters = Object.fromEntries(formData.entries());
    loadIssuesWithFilters(filters);
  });

  document.getElementById('reset-filters')?.addEventListener('click', function() {
    ['category-filter', 'status-filter', 'search-filter', 'sort-filter'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = el.id === 'sort-filter' ? '-created_at' : '';
    });
    document.querySelectorAll('.filter-badge').forEach(el => el.remove());
    
    const formData = new FormData(document.getElementById('filter-form'));
    loadIssuesWithFilters(Object.fromEntries(formData.entries()));
  });

  document.querySelectorAll('.filter-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const f = this.dataset.filter;
      const el = document.getElementById(f + '-filter');
      if (el) el.value = '';
      this.remove();
      const formData = new FormData(document.getElementById('filter-form'));
      loadIssuesWithFilters(Object.fromEntries(formData.entries()));
    });
  });

  let searchTimeout;
  document.getElementById('search-filter')?.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    if (e.target.value.length > 2 || e.target.value.length === 0) {
      searchTimeout = setTimeout(() => {
        const formData = new FormData(document.getElementById('filter-form'));
        loadIssuesWithFilters(Object.fromEntries(formData.entries()));
      }, 500);
    }
  });

  // === –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï –ü–û –ê–î–†–ï–°–£ ===
  let selectedIndex = -1;
  
  function clearSearchResults() {
    const div = document.getElementById('map-search-results');
    if (div) { div.innerHTML = ''; div.style.display = 'none'; }
    selectedIndex = -1;
  }

  function showSearchResults(results) {
    selectedIndex = -1;
    const div = document.getElementById('map-search-results');
    if (!div) return;
    div.innerHTML = '';
    
    if (!results || results.length === 0) {
      div.innerHTML = `
        <div class="map-search-no-results">
          <div class="map-search-no-results-icon">üìç</div>
          <div class="map-search-no-results-text">–ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<br><small style="font-size: 12px; opacity: 0.7;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</small></div>
        </div>
      `;
      div.style.display = 'block';
      return;
    }

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const header = document.createElement('div');
    header.className = 'map-search-results-header';
    header.innerHTML = `
      <span>üìç –ù–∞–π–¥–µ–Ω–æ –∞–¥—Ä–µ—Å–æ–≤</span>
      <span class="map-search-results-count">${results.length}</span>
    `;
    div.appendChild(header);

    results.forEach((r, index) => {
      const item = document.createElement('div');
      item.className = 'map-search-result-item';
      if (index === 0) item.classList.add('active');
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞
      const addr = r.address || {};
      const road = addr.road || '';
      const houseNumber = addr.house_number || '';
      const city = addr.city || addr.town || addr.municipality || '';
      const district = addr.suburb || addr.quarter || addr.neighbourhood || '';
      const postcode = addr.postcode || '';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∞–¥—Ä–µ—Å
      let mainAddress = '';
      if (road) {
        mainAddress = road;
        if (houseNumber) mainAddress += `, ${houseNumber}`;
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è —É–ª–∏—Ü—ã, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å display_name
        mainAddress = r.display_name.split(',')[0] || r.display_name;
      }
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏
      const details = [];
      if (district) details.push({ icon: 'üèòÔ∏è', text: district });
      if (city && city !== district) details.push({ icon: 'üèôÔ∏è', text: city });
      if (postcode) details.push({ icon: 'üìÆ', text: postcode });
      
      // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML
      item.innerHTML = `
        <div class="map-search-result-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </div>
        <div class="map-search-result-content">
          <div class="map-search-result-main">${mainAddress}</div>
          ${details.length > 0 ? `
            <div class="map-search-result-details">
              ${details.map(d => `
                <span class="map-search-result-detail">
                  <span class="map-search-result-detail-icon">${d.icon}</span>
                  <span>${d.text}</span>
                </span>
              `).join('')}
            </div>
          ` : ''}
          <div class="map-search-result-address">${r.display_name}</div>
        </div>
      `;
      
      item.onclick = () => {
        const lat = r.lat, lon = r.lon, addr = r.display_name;
        map.flyTo({ center: [lon, lat], zoom: 16 });
        clearSearchResults();
        if (tempMarker) tempMarker.remove();
        tempMarker = new maplibregl.Marker({ color: '#3498db' })
          .setLngLat([lon, lat])
          .setPopup(new maplibregl.Popup().setText(addr))
          .addTo(map);
        tempMarker.togglePopup();
        if ({% if user.is_authenticated and user.role == 'citizen' %}true{% else %}false{% endif %}) {
          showReportButton(lat, lon, addr);
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º
        if (searchInput) {
          searchInput.value = mainAddress;
        }
      };
      
      div.appendChild(item);
    });
    
    div.style.display = 'block';
  }

  let searchDebounce;
  const searchInput = document.getElementById('map-address-search');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchDebounce);
      const q = this.value.trim();
      if (q.length < 2) return clearSearchResults();
      searchDebounce = setTimeout(async () => {
        try {
          const res = await fetch(`/issues/api/search-address/?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          showSearchResults(data.results);
        } catch (e) {
          console.warn('Search failed:', e);
          clearSearchResults();
        }
      }, 300);
    });

    searchInput.addEventListener('keydown', (e) => {
      const div = document.getElementById('map-search-results');
      const items = div?.querySelectorAll('.map-search-result-item');
      
      if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && items && items[selectedIndex]) {
          items[selectedIndex].click();
        } else if (items && items.length > 0) {
          items[0].click();
        } else if (searchInput.value.trim()) {
          searchInput.dispatchEvent(new Event('input'));
        }
        selectedIndex = -1;
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!items || items.length === 0) return;
        if (selectedIndex >= 0) {
          items[selectedIndex].classList.remove('active');
        }
        selectedIndex = (selectedIndex + 1) % items.length;
        items[selectedIndex].classList.add('active');
        items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (!items || items.length === 0) return;
        if (selectedIndex >= 0) {
          items[selectedIndex].classList.remove('active');
        }
        selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
        items[selectedIndex].classList.add('active');
        items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else if (e.key === 'Escape') {
        clearSearchResults();
        selectedIndex = -1;
      }
    });
  }

  document.getElementById('map-search-btn')?.addEventListener('click', () => {
    if (searchInput) searchInput.dispatchEvent(new Event('input'));
  });

  document.addEventListener('click', e => {
    const container = document.querySelector('.map-search-container');
    if (container && !container.contains(e.target)) clearSearchResults();
  });

  // === –ö–ù–û–ü–ö–ê ¬´–°–û–û–ë–©–ò–¢–¨¬ª ===
  function showReportButton(lat, lon, address) {
    const old = document.getElementById('map-report-btn');
    if (old) old.remove();

    const btn = Object.assign(document.createElement('button'), {
      id: 'map-report-btn',
      className: 'btn btn-success btn-sm',
      innerHTML: '{% trans "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ –∑–¥–µ—Å—å" %}',
      style: 'position:absolute;top:10px;left:10px;z-index:2'
    });

    btn.onclick = () => {
      const url = new URL('{% url "issues:create_issue" %}', location.origin);
      url.searchParams.set('lat', lat.toFixed(6));
      url.searchParams.set('lon', lon.toFixed(6));
      url.searchParams.set('address', address);
      location.href = url.toString();
    };

    document.getElementById('map').appendChild(btn);
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  const userIsCitizen = {% if user.is_authenticated and user.role == 'citizen' %}true{% else %}false{% endif %};

  map.on('load', () => {
    // –ú–∞—Ä–∫–µ—Ä—ã (—É–∂–µ –µ—Å—Ç—å –≤—ã—à–µ ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º)
    {% for issue in issues %}
      {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
        {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
          {% if lng != "None" and lat != "None" %}
            {
              const lng = parseFloat("{{ lng }}");
              const lat = parseFloat("{{ lat }}");
              if (!isNaN(lng) && !isNaN(lat)) {
                const popup = new maplibregl.Popup({
                  closeButton: false,
                  closeOnClick: false,
                  anchor: 'top',
                  offset: [0, -8],
                  maxWidth: '220px'
                }).setHTML(`
                  <a href="{% url 'issues:issue_detail' issue.id %}"
                     style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                    {{ issue.title|escapejs }}
                  </a>
                  <small>
                    –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                    –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                    {% if issue.photos.all %}
                      <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                    {% endif %}
                  </small>
                `);
                const marker = new maplibregl.Marker({ color: '#E75A7C' }).setLngLat([lng, lat]).addTo(map);
                const el = marker.getElement();
                if (el) {
                  el.addEventListener('mouseenter', () => popup.setLngLat(marker.getLngLat()).addTo(map));
                  el.addEventListener('mouseleave', () => popup.isOpen() && popup.remove());
                  el.addEventListener('click', () => location.href = "{% url 'issues:issue_detail' issue.id %}");
                }
                markers.push(marker);
              }
            }
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –æ–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞
    if (userIsCitizen) {
        map.on('click', async function(e) {
          if (e.originalEvent.target.closest('.maplibregl-marker, .maplibregl-popup')) return;
        
          const lng = e.lngLat.lng;
          const lat = e.lngLat.lat;
        
          // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
          let address = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          try {
            const resp = await fetch(`/issues/api/reverse-geocode/?lat=${lat}&lon=${lng}`);
            const data = await resp.json();
            if (data.address) {
              address = data.address;
            }
          } catch (err) {
            console.warn('Reverse geocode failed:', err);
        }

        if (tempMarker) tempMarker.remove();
        tempMarker = new maplibregl.Marker({ color: '#3498db' })
          .setLngLat([lng, lat])
          .setPopup(new maplibregl.Popup().setText(address))
          .addTo(map);
        tempMarker.togglePopup();

        showReportButton(lat, lng, address);
      });
    }
  });

  map.on('error', e => {
    console.error('Map error:', e);
    document.getElementById('map').innerHTML =
      `<div class="alert alert-danger p-3">‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: ${e.error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
  });
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
{% if user.is_authenticated and user.role == 'citizen' %}
<div id="modal-backdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999;"></div>
<div id="report-form-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; width:90%; max-width:500px;">
  <h5>{% trans "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ" %}</h5>
  <form method="post" action="{% url 'issues:create_issue' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" id="id_lat" name="lat">
    <input type="hidden" id="id_lon" name="lon">
    <div class="mb-3"><label class="form-label">{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ" %}</label><input type="text" name="title" class="form-control" required></div>
    <div class="mb-3"><label class="form-label">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}</label><textarea name="description" class="form-control" rows="3" required></textarea></div>
    <div class="mb-3"><label class="form-label">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
      <select name="category" class="form-select" required>
        {% for value, label in categories %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="modal-images" class="form-label">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %} (–¥–æ 5, JPG/PNG, –º–∞–∫—Å. 5MB)</label>
      <input type="file" class="form-control" id="modal-images" name="images" multiple accept="image/jpeg, image/png">
      <div id="modal-preview" class="mt-2 d-flex flex-wrap gap-1"></div>
      <small class="form-text text-muted">{% trans "–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤" %}</small>
    </div>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-secondary me-2"
              onclick="document.getElementById('report-form-modal').style.display='none';document.getElementById('modal-backdrop').style.display='none';if (typeof tempMarker !== 'undefined' && tempMarker !== null) { tempMarker.remove(); tempMarker = null; }">
        {% trans "–û—Ç–º–µ–Ω–∞" %}
      </button>
      <button type="submit" class="btn btn-success">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const inp = document.getElementById('modal-images');
    if (!inp) return;
    inp.addEventListener('change', function() {
      const preview = document.getElementById('modal-preview');
      preview.innerHTML = '';
      if (this.files.length > 5) alert('{% trans "–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ë—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5." %}');
      Array.from(this.files).slice(0, 5).forEach(file => {
        if (file.size > 5 * 1024 * 1024) return preview.appendChild(Object.assign(document.createElement('div'), { className: 'text-danger small mt-1', textContent: `‚ö†Ô∏è ${file.name} {% trans "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π" %}` }));
        if (!file.type.match('image.*')) return preview.appendChild(Object.assign(document.createElement('div'), { className: 'text-danger small mt-1', textContent: `‚ö†Ô∏è ${file.name} {% trans "–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" %}` }));
        const reader = new FileReader();
        reader.onload = e => {
          const img = Object.assign(document.createElement('img'), {
            src: e.target.result,
            style: 'width:60px;height:60px;object-fit:cover;border-radius:4px;border:1px solid #ddd'
          });
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
  });
</script>
{% endif %}

{% csrf_token %}

<script>
function toggleVote(issueId, intendedValue, isUpvoted, isDownvoted) {
    let voteValue = intendedValue.toString();
    if ((intendedValue === 1 && isUpvoted) || (intendedValue === -1 && isDownvoted)) voteValue = '0';

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('vote', voteValue);

    const card = document.querySelector(`.card[data-issue-id="${issueId}"]`);
    if (!card) return;

    const buttons = card.querySelectorAll(`button[onclick*="toggleVote(${issueId},"]`);
    buttons.forEach(b => { b.disabled = true; b.innerHTML = '‚ãØ'; });

    fetch(`/issues/${issueId}/vote/`, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json().then(d => r.ok ? d : Promise.reject(d)))
    .then(data => {
        const badge = card.querySelector('.badge.bg-primary');
        if (badge) badge.innerHTML = `${data.rating} {% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}`;
        document.querySelectorAll('.maplibregl-popup-content').forEach(p => {
            if (p.innerHTML.includes(`/issues/${issueId}/`)) {
                const small = p.querySelector('small');
                if (small) small.innerHTML = small.innerHTML.replace(
                    /–†–µ–π—Ç–∏–Ω–≥: <strong>\d+<\/strong>/,
                    `–†–µ–π—Ç–∏–Ω–≥: <strong>${data.rating}</strong>`
                );
            }
        });
        const up = card.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = card.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up && down) {
            up.className = up.className.replace(/\b(btn-success|btn-outline-success)\b/g, data.user_vote === 1 ? 'btn-success' : 'btn-outline-success');
            down.className = down.className.replace(/\b(btn-danger|btn-outline-danger)\b/g, data.user_vote === -1 ? 'btn-danger' : 'btn-outline-danger');
        }
    })
    .catch(err => {
        console.error('Vote error:', err);
        alert(err.error || '{% trans "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è." %}');
    })
    .finally(() => {
        const up = card.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = card.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up) up.innerHTML = 'üëç';
        if (down) down.innerHTML = 'üëé';
        if (up) up.disabled = false;
        if (down) down.disabled = false;
    });
}
</script>

{% endblock %}