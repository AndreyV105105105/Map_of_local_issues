{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="{% static 'css/map.css' %}"> <!-- –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–∞–π–ª—É -->
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ MapLibre GL -->
    <link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="map-header">
  <h2>{% trans "–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫)" %}</h2>

  {% if user.is_authenticated and user.role == 'citizen' %}
    <div class="map-instruction">
      <p>{% trans "–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏." %}
    </div>
  {% endif %}
</div>

<!-- –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É ‚Äî –ø–æ–≤–µ—Ä—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç—ã -->
<div class="map-search-container">
  <div class="input-group map-search-input-group">
    <input type="text" id="map-address-search" class="form-control map-search-input"
          placeholder="{% trans '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å: –õ–µ–Ω–∏–Ω–∞, –ú–∏—Ä–∞, –ù–µ—Ñ—Ç—è–Ω–∏–∫–æ–≤...' %}">
    <button class="map-search-btn" type="button" id="map-search-btn">
      <i class="bi bi-search"></i> 
    </button>
  </div>
  <div id="map-search-results" class="map-search-results"></div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
<div id="map-container">
    <div id="map"></div>
</div>

<div class="container mt-4">
  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
  <div class="map-filters-container">
    <h5>{% trans "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π" %}</h5>
    <form id="filter-form" class="map-filter-row">
      <div class="map-filter-item">
        <label for="category-filter" class="form-label small">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
        <select id="category-filter" name="category" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" %}</option>
          {% for value, label in categories %}
            <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="map-filter-item">
        <label for="status-filter" class="form-label small">{% trans "–°—Ç–∞—Ç—É—Å" %}</label>
        <select id="status-filter" name="status" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" %}</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="map-filter-item">
        <label for="search-filter" class="form-label small">{% trans "–ü–æ–∏—Å–∫" %}</label>
        <input type="text" id="search-filter" name="search" class="form-control form-control-sm"
              placeholder="{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä..." %}" value="{{ search_query }}">
      </div>

      <div class="map-filter-item">
        <label for="sort-filter" class="form-label small">{% trans "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" %}</label>
        <select id="sort-filter" name="sort" class="form-select form-select-sm">
          <option value="-created_at" {% if selected_sort == "-created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" %}</option>
          <option value="created_at" {% if selected_sort == "created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ" %}</option>
          <option value="-vote_rating" {% if selected_sort == "-vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="vote_rating" {% if selected_sort == "vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="title" {% if selected_sort == "title" %}selected{% endif %}>{% trans "–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é" %}</option>
        </select>
      </div>

      <div class="map-filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}</button>
        <button type="button" id="reset-filters" class="btn btn-secondary btn-sm">{% trans "–°–±—Ä–æ—Å–∏—Ç—å" %}</button>
      </div>
    </form>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    {% if selected_category or selected_status or search_query %}
    <div class="map-active-filters">
      <small class="text-muted">{% trans "–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:" %}</small>
      {% if selected_category %}
        <span class="badge bg-info filter-badge" data-filter="category">
          {% for value, label in categories %}
            {% if value == selected_category %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if selected_status %}
        <span class="badge bg-warning filter-badge" data-filter="status">
          {% for value, label in status_choices %}
            {% if value == selected_status %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if search_query %}
        <span class="badge bg-success filter-badge" data-filter="search">{{ search_query }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
  <div id="issues-container">
    {% include "issues/partials/issues_list.html" %}
  </div>
</div>


{% csrf_token %}


<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>


<script>
    window.USER_IS_CITIZEN = {% if user.is_authenticated and user.role == 'citizen' %}true{% else %}false{% endif %};
    window.MARKER_COLOR = '#E75A7C'; // –¶–≤–µ—Ç –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —à–∞–±–ª–æ–Ω–∞

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–∞
    window.loadInitialMarkersFromTemplate = function() {
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        markers.forEach(marker => marker.remove());
        markers = [];

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Django-–∫–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        {% for issue in issues %}
          {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
            {% with lng=issue.location.x|floatformat:"6"|floatformat:"g" lat=issue.location.y|floatformat:"6"|floatformat:"g" %}
              {% if lng != "None" and lat != "None" %}
                {
                  const lng = parseFloat("{{ lng|safe }}");
                  const lat = parseFloat("{{ lat|safe }}");
                  if (!isNaN(lng) && !isNaN(lat)) {
                    const popup = new maplibregl.Popup({
                      closeButton: false,
                      closeOnClick: false,
                      anchor: 'top',
                      offset: [0, -8],
                      maxWidth: '220px'
                    }).setHTML(`
                      <a href="{% url 'issues:issue_detail' issue.id %}"
                         style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                        {{ issue.title|escapejs }}
                      </a>
                      <small>
                        –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                        –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                        {% if issue.photos.all %}
                          <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                        {% endif %}
                      </small>
                    `);

                    const marker = new maplibregl.Marker({ color: window.MARKER_COLOR })
                      .setLngLat([lng, lat])
                      .addTo(map);

                    const markerEl = marker.getElement();
                    if (markerEl) {
                      markerEl.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        popup.setLngLat(marker.getLngLat()).addTo(map);
                      });
                      markerEl.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        if (popup.isOpen()) popup.remove();
                      });
                      markerEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                      });
                    }

                    markers.push(marker);
                  }
                }
              {% endif %}
            {% endwith %}
          {% endif %}
        {% endfor %}
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ (–¥–ª—è updateMapMarkers)
    window.loadInitialMarkersOnError = function() {
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        markers.forEach(marker => marker.remove());
        markers = [];

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Django-–∫–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ (—Ç–æ—Ç –∂–µ –∫–æ–¥)
        {% for issue in issues %}
          {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
            {% with lng=issue.location.x|floatformat:"6"|floatformat:"g" lat=issue.location.y|floatformat:"6"|floatformat:"g" %}
              {% if lng != "None" and lat != "None" %}
                {
                  const lng = parseFloat("{{ lng|safe }}");
                  const lat = parseFloat("{{ lat|safe }}");
                  if (!isNaN(lng) && !isNaN(lat)) {
                    const popup = new maplibregl.Popup({
                      closeButton: false,
                      closeOnClick: false,
                      anchor: 'top',
                      offset: [0, -8],
                      maxWidth: '220px'
                    }).setHTML(`
                      <a href="{% url 'issues:issue_detail' issue.id %}"
                         style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                        {{ issue.title|escapejs }}
                      </a>
                      <small>
                        –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                        –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                        {% if issue.photos.all %}
                          <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                        {% endif %}
                      </small>
                    `);

                    const marker = new maplibregl.Marker({ color: window.MARKER_COLOR })
                      .setLngLat([lng, lat])
                      .addTo(map);

                    const markerEl = marker.getElement();
                    if (markerEl) {
                      markerEl.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        popup.setLngLat(marker.getLngLat()).addTo(map);
                      });
                      markerEl.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        if (popup.isOpen()) popup.remove();
                      });
                      markerEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                      });
                    }

                    markers.push(marker);
                  }
                }
              {% endif %}
            {% endwith %}
          {% endif %}
        {% endfor %}
    };

</script>


<script src="{% static 'js/map.js' %}"></script> 

{% endblock %}