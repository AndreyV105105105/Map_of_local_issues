{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<style>
  .filter-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
  }
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }
  .filter-item {
    flex: 1;
    min-width: 150px;
  }
  .filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    align-items: flex-end;
  }
  .filter-badge {
    cursor: pointer;
  }
  #map {
    height: 600px;
    width: 100%;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{% trans "–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫)" %}</h2>

  {% if user.is_authenticated and user.role == 'citizen' %}
    <div class="alert alert-info">
      {% trans "–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Å–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ." %}
    </div>
  {% endif %}

  <div id="map" style="height: 600px; width: 100%; border: 1px solid #ccc; border-radius: 4px;"></div>

  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
  <div class="filter-container mt-4">
    <h5 class="mb-3">{% trans "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π" %}</h5>
    <form id="filter-form" class="filter-row">
      <div class="filter-item">
        <label for="category-filter" class="form-label small">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
        <select id="category-filter" name="category" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" %}</option>
          {% for value, label in categories %}
            <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-item">
        <label for="status-filter" class="form-label small">{% trans "–°—Ç–∞—Ç—É—Å" %}</label>
        <select id="status-filter" name="status" class="form-select form-select-sm">
          <option value="">{% trans "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" %}</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-item">
        <label for="search-filter" class="form-label small">{% trans "–ü–æ–∏—Å–∫" %}</label>
        <input type="text" id="search-filter" name="search" class="form-control form-control-sm"
               placeholder="{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä..." %}" value="{{ search_query }}">
      </div>

      <div class="filter-item">
        <label for="sort-filter" class="form-label small">{% trans "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" %}</label>
        <select id="sort-filter" name="sort" class="form-select form-select-sm">
          <option value="-created_at" {% if selected_sort == "-created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" %}</option>
          <option value="created_at" {% if selected_sort == "created_at" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ" %}</option>
          <option value="-vote_rating" {% if selected_sort == "-vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="vote_rating" {% if selected_sort == "vote_rating" %}selected{% endif %}>{% trans "–°–Ω–∞—á–∞–ª–∞ —Å –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º" %}</option>
          <option value="title" {% if selected_sort == "title" %}selected{% endif %}>{% trans "–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é" %}</option>
        </select>
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}</button>
        <button type="button" id="reset-filters" class="btn btn-outline-secondary btn-sm">{% trans "–°–±—Ä–æ—Å–∏—Ç—å" %}</button>
      </div>
    </form>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    {% if selected_category or selected_status or search_query %}
    <div class="mt-3">
      <small class="text-muted">{% trans "–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:" %}</small>
      {% if selected_category %}
        <span class="badge bg-info filter-badge me-1" data-filter="category">
          {% for value, label in categories %}
            {% if value == selected_category %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if selected_status %}
        <span class="badge bg-warning filter-badge me-1" data-filter="status">
          {% for value, label in status_choices %}
            {% if value == selected_status %}{{ label }}{% endif %}
          {% endfor %}
        </span>
      {% endif %}
      {% if search_query %}
        <span class="badge bg-success filter-badge me-1" data-filter="search">{{ search_query }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
  <div id="issues-container">
    {% include "issues/partials/issues_list.html" %}
  </div>
</div>

<!-- MapLibre GL -->
<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" rel="stylesheet" />

<script>
  const bounds = [
    [68.75, 60.75],
    [69.30, 61.15]
  ];

  // –•—Ä–∞–Ω–∏–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
  let markers = [];

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'osm': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.de/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }
      },
      layers: [{
        id: 'osm-tiles',
        type: 'raster',
        source: 'osm',
        minzoom: 0,
        maxzoom: 19
      }]
    },
    center: [69.0179, 61.0034],
    zoom: 12,
    maxBounds: bounds
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.addControl(new maplibregl.ScaleControl({ maxWidth: 100 }), 'bottom-left');

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
  function updateMapMarkers(filters) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
    markers.forEach(marker => marker.remove());
    markers = [];

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã
    fetch(`/issues/map/geojson/?${new URLSearchParams(filters)}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç—ã');
        }
        return response.json();
    })
    .then(geojson => {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        geojson.features.forEach(feature => {
            const lng = feature.geometry.coordinates[0];
            const lat = feature.geometry.coordinates[1];
            const props = feature.properties;

            if (!isNaN(lng) && !isNaN(lat)) {
                const popupContent = `
                    <a href="${props.url}"
                       style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                        ${props.title}
                    </a>
                    <small>
                        –°—Ç–∞—Ç—É—Å: <strong>${props.status_display}</strong><br>
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${props.category_display}<br>
                        –†–µ–π—Ç–∏–Ω–≥: <strong>${props.vote_rating}</strong>
                        ${props.photos_count > 0 ? `<br>üì∏ ${props.photos_count} {% trans "—Ñ–æ—Ç–æ" %}` : ''}
                    </small>
                `;

                const popup = new maplibregl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    anchor: 'top',
                    offset: [0, -8],
                    maxWidth: '220px'
                }).setHTML(popupContent);

                const marker = new maplibregl.Marker({ color: '#e74c3c' })
                    .setLngLat([lng, lat])
                    .setPopup(popup)
                    .addTo(map);

                const markerEl = marker.getElement();
                if (markerEl) {
                    markerEl.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        popup.addTo(map);
                    });
                    markerEl.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        if (popup.isOpen()) popup.remove();
                    });

                    markerEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = props.url;
                    });
                }

                markers.push(marker);
            }
        });
    })
    .catch(error => {
        console.error('Error updating map markers:', error);
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
        setTimeout(() => {
            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => marker.remove());
            markers = [];

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            {% for issue in issues %}
              {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
                {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
                  {% if lng != "None" and lat != "None" %}
                    {
                      const lng = parseFloat("{{ lng }}");
                      const lat = parseFloat("{{ lat }}");
                      if (!isNaN(lng) && !isNaN(lat)) {
                        const popup = new maplibregl.Popup({
                          closeButton: false,
                          closeOnClick: false,
                          anchor: 'top',
                          offset: [0, -8],
                          maxWidth: '220px'
                        }).setHTML(`
                          <a href="{% url 'issues:issue_detail' issue.id %}"
                             style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                            {{ issue.title|escapejs }}
                          </a>
                          <small>
                            –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                            –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                            {% if issue.photos.all %}
                              <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                            {% endif %}
                          </small>
                        `);

                        const marker = new maplibregl.Marker({ color: '#e74c3c' })
                          .setLngLat([lng, lat])
                          .addTo(map);

                        const markerEl = marker.getElement();
                        if (markerEl) {
                          markerEl.addEventListener('mouseenter', (e) => {
                            e.stopPropagation();
                            popup.setLngLat(marker.getLngLat()).addTo(map);
                          });
                          markerEl.addEventListener('mouseleave', (e) => {
                            e.stopPropagation();
                            if (popup.isOpen()) popup.remove();
                          });

                          markerEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                          });
                        }

                        markers.push(marker);
                      }
                    }
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% endfor %}
        }, 500);
    });
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
  function loadIssuesWithFilters(filters) {
    // –û–±–Ω–æ–≤–ª—è–µ–º URL
    const url = new URL(window.location.href);
    Object.entries(filters).forEach(([key, value]) => {
      if (value) {
        url.searchParams.set(key, value);
      } else {
        url.searchParams.delete(key);
      }
    });
    history.pushState({}, '', url);

    document.querySelector('#filter-form button[type="submit"]').disabled = true;
    document.querySelector('#filter-form button[type="submit"]').innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

    return fetch(`/issues/map/?${new URLSearchParams(filters)}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      }
      return response.text();
    })
    .then(html => {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π
      document.getElementById('issues-container').innerHTML = html;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å —Ç–µ–º–∏ –∂–µ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
      updateMapMarkers(filters);
    })
    .catch(error => {
      console.error('Error loading filtered issues:', error);
      alert('{% trans "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." %}');
    })
    .finally(() => {
      document.querySelector('#filter-form button[type="submit"]').disabled = false;
      document.querySelector('#filter-form button[type="submit"]').innerHTML = '{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" %}';
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const filters = Object.fromEntries(formData.entries());

    loadIssuesWithFilters(filters);
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.getElementById('reset-filters').addEventListener('click', function() {
    document.getElementById('category-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('search-filter').value = '';
    document.getElementById('sort-filter').value = '-created_at';

    document.querySelectorAll('.filter-badge').forEach(badge => badge.remove());

    const formData = new FormData(document.getElementById('filter-form'));
    const filters = Object.fromEntries(formData.entries());

    loadIssuesWithFilters(filters);
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –±–µ–π–¥–∂–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.querySelectorAll('.filter-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      const filterType = this.dataset.filter;
      if (filterType === 'category') {
        document.getElementById('category-filter').value = '';
      } else if (filterType === 'status') {
        document.getElementById('status-filter').value = '';
      } else if (filterType === 'search') {
        document.getElementById('search-filter').value = '';
      }

      this.remove();

      const formData = new FormData(document.getElementById('filter-form'));
      const filters = Object.fromEntries(formData.entries());

      loadIssuesWithFilters(filters);
    });
  });

  // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
  let searchTimeout;
  document.getElementById('search-filter').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (e.target.value.length > 2 || e.target.value.length === 0) {
        const formData = new FormData(document.getElementById('filter-form'));
        const filters = Object.fromEntries(formData.entries());
        loadIssuesWithFilters(filters);
      }
    }, 500);
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
  map.on('load', () => {
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
    {% for issue in issues %}
      {% if issue.location and issue.location.x is not None and issue.location.y is not None %}
        {% with lng=issue.location.x|floatformat:"6" lat=issue.location.y|floatformat:"6" %}
          {% if lng != "None" and lat != "None" %}
            {
              const lng = parseFloat("{{ lng }}");
              const lat = parseFloat("{{ lat }}");
              if (!isNaN(lng) && !isNaN(lat)) {
                const popup = new maplibregl.Popup({
                  closeButton: false,
                  closeOnClick: false,
                  anchor: 'top',
                  offset: [0, -8],
                  maxWidth: '220px'
                }).setHTML(`
                  <a href="{% url 'issues:issue_detail' issue.id %}"
                     style="text-decoration: none; color: inherit; font-weight: bold; display: block; margin-bottom: 4px;">
                    {{ issue.title|escapejs }}
                  </a>
                  <small>
                    –°—Ç–∞—Ç—É—Å: <strong>{{ issue.get_status_display }}</strong><br>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ issue.get_category_display }}<br>
                    –†–µ–π—Ç–∏–Ω–≥: <strong>{{ issue.vote_rating }}</strong>
                    {% if issue.photos.all %}
                      <br>üì∏ {{ issue.photos.count }} {% trans "—Ñ–æ—Ç–æ" %}
                    {% endif %}
                  </small>
                `);

                const marker = new maplibregl.Marker({ color: '#e74c3c' })
                  .setLngLat([lng, lat])
                  .addTo(map);

                const markerEl = marker.getElement();
                if (markerEl) {
                  markerEl.addEventListener('mouseenter', (e) => {
                    e.stopPropagation();
                    popup.setLngLat(marker.getLngLat()).addTo(map);
                  });
                  markerEl.addEventListener('mouseleave', (e) => {
                    e.stopPropagation();
                    if (popup.isOpen()) popup.remove();
                  });

                  markerEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.location.href = "{% url 'issues:issue_detail' issue.id %}";
                  });
                }

                markers.push(marker);
              }
            }
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    {% if user.is_authenticated and user.role == 'citizen' %}
      let tempMarker = null;
      map.on('click', function(e) {
        const clickedOnMarker = e.originalEvent.target.closest('.maplibregl-marker');
        if (clickedOnMarker) return;

        const lng = e.lngLat.lng.toFixed(6);
        const lat = e.lngLat.lat.toFixed(6);

        if (tempMarker) tempMarker.remove();

        tempMarker = new maplibregl.Marker({ color: '#3498db' })
          .setLngLat([lng, lat])
          .setPopup(new maplibregl.Popup().setText("{% trans '–ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–æ–±—â–∏—Ç—å¬ª –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å' %}"))
          .addTo(map);

        tempMarker.togglePopup();

        const latInput = document.getElementById('id_lat');
        const lonInput = document.getElementById('id_lon');
        if (latInput) latInput.value = lat;
        if (lonInput) lonInput.value = lng;

        const modal = document.getElementById('report-form-modal');
        const backdrop = document.getElementById('modal-backdrop');
        if (modal && backdrop) {
          modal.style.display = 'block';
          backdrop.style.display = 'block';
        }
      });
    {% endif %}
  });

  map.on('error', (e) => {
    console.error('Map error:', e);
    document.getElementById('map').innerHTML =
      `<div class="alert alert-danger p-3">‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: ${e.error?.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
  });
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω -->
{% if user.is_authenticated and user.role == 'citizen' %}
<div id="modal-backdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999;"></div>
<div id="report-form-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; width:90%; max-width:500px;">
  <h5>{% trans "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ" %}</h5>
  <form method="post" action="{% url 'issues:create_issue' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" id="id_lat" name="lat">
    <input type="hidden" id="id_lon" name="lon">
    <div class="mb-3"><label class="form-label">{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ" %}</label><input type="text" name="title" class="form-control" required></div>
    <div class="mb-3"><label class="form-label">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}</label><textarea name="description" class="form-control" rows="3" required></textarea></div>
    <div class="mb-3"><label class="form-label">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
      <select name="category" class="form-select" required>
        {% for value, label in categories %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
    <div class="mb-3">
      <label for="modal-images" class="form-label">{% trans "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %} (–¥–æ 5, JPG/PNG, –º–∞–∫—Å. 5MB)</label>
      <input type="file" class="form-control" id="modal-images" name="images" multiple accept="image/jpeg, image/png">
      <div id="modal-preview" class="mt-2 d-flex flex-wrap gap-1"></div>
      <small class="form-text text-muted">{% trans "–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤" %}</small>
    </div>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-secondary me-2"
              onclick="document.getElementById('report-form-modal').style.display='none';document.getElementById('modal-backdrop').style.display='none';if (typeof tempMarker !== 'undefined' && tempMarker !== null) { tempMarker.remove(); tempMarker = null; }">
        {% trans "–û—Ç–º–µ–Ω–∞" %}
      </button>
      <button type="submit" class="btn btn-success">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
    </div>
  </form>
</div>

<script>
  // –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('modal-images');
    if (imageInput) {
      imageInput.addEventListener('change', function() {
        const preview = document.getElementById('modal-preview');
        preview.innerHTML = '';  // –û—á–∏—Å—Ç–∫–∞

        if (this.files.length > 5) {
          alert('{% trans "–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ë—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5." %}');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const filesToShow = Array.from(this.files).slice(0, 5);

        filesToShow.forEach(file => {
          if (file.size > 5 * 1024 * 1024) {
            const warning = document.createElement('div');
            warning.className = 'text-danger small mt-1';
            warning.textContent = `‚ö†Ô∏è ${file.name} {% trans "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)" %}`;
            preview.appendChild(warning);
            return;
          }

          if (!file.type.match('image.*')) {
            const warning = document.createElement('div');
            warning.className = 'text-danger small mt-1';
            warning.textContent = `‚ö†Ô∏è ${file.name} {% trans "–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º" %}`;
            preview.appendChild(warning);
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            img.style.border = '1px solid #ddd';
            img.title = file.name;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });
    }
  });
</script>
{% endif %}

<!-- CSRF –¥–ª—è JS -->
{% csrf_token %}

<!-- JS: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–º–µ–Ω–æ–π -->
<script>
function toggleVote(issueId, intendedValue, isUpvoted, isDownvoted) {
    let voteValue = null;
    if (intendedValue === 1 && isUpvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else if (intendedValue === -1 && isDownvoted) {
        voteValue = '0';  // –æ—Ç–º–µ–Ω–∞
    } else {
        voteValue = intendedValue.toString();
    }

    const formData = new FormData();
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrf);
    formData.append('vote', voteValue);

    // –ù–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø—Ä–æ–±–ª–µ–º–æ–π
    const card = document.querySelector(`.card[data-issue-id="${issueId}"]`);
    if (!card) return;

    const buttons = card.querySelectorAll(`button[onclick*="toggleVote(${issueId},"]`);
    buttons.forEach(b => { b.disabled = true; b.innerHTML = '‚ãØ'; });

    fetch(`/issues/${issueId}/vote/`, {
        method: 'POST',
        body: formData,
        redirect: 'follow',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json().then(data => r.ok ? data : Promise.reject(data)))
    .then(data => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
        const ratingBadge = card.querySelector('.badge.bg-primary');
        if (ratingBadge) {
            ratingBadge.innerHTML = `${data.rating} {% trans "—Ä–µ–π—Ç–∏–Ω–≥" %}`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ popup –Ω–∞ –∫–∞—Ä—Ç–µ
        document.querySelectorAll('.maplibregl-popup-content').forEach(popup => {
            if (popup.innerHTML.includes(`/issues/${issueId}/`)) {
                const ratingElement = popup.querySelector('small');
                if (ratingElement) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º
                    ratingElement.innerHTML = ratingElement.innerHTML.replace(
                        /–†–µ–π—Ç–∏–Ω–≥: <strong>\d+<\/strong>/,
                        `–†–µ–π—Ç–∏–Ω–≥: <strong>${data.rating}</strong>`
                    );
                }
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
        const up = card.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = card.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up && down) {
            up.classList.toggle('btn-success', data.user_vote === 1);
            up.classList.toggle('btn-outline-success', data.user_vote !== 1);
            down.classList.toggle('btn-danger', data.user_vote === -1);
            down.classList.toggle('btn-outline-danger', data.user_vote !== -1);
        }
    })
    .catch(err => {
        console.error('Vote error:', err);
        alert(err.error || '{% trans "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è." %}');
    })
    .finally(() => {
        const up = card.querySelector(`button[onclick*="toggleVote(${issueId}, 1"]`);
        const down = card.querySelector(`button[onclick*="toggleVote(${issueId}, -1"]`);
        if (up) up.innerHTML = 'üëç'; if (down) down.innerHTML = 'üëé';
        if (up) up.disabled = false; if (down) down.disabled = false;
    });
}
</script>

{% endblock %}